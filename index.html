<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Version: 2026-01-13-18:00 -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paleto Garage - Gestion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://use.typekit.net/slu2xto.css">
<style>
:root {
  --color-primary: #1a1a2e;
  --color-secondary: #0d1117;
  --color-accent: #0f3460;
  --color-highlight: #e94560;
  --color-gold: #d4af37;
  --color-bg: #0a0a12;
  --color-surface: #1a1a2e;
  --color-text: #e8e8e8;
  --color-text-dim: #a0a0a8;
  --color-border: #2a2a3e;
}

[data-theme="light"] {
  --color-primary: #f8fafc;
  --color-secondary: #e2e8f0;
  --color-accent: #cbd5e1;
  --color-highlight: #6366f1;
  --color-gold: #8b5cf6;
  --color-bg: #ffffff;
  --color-surface: #f8fafc;
  --color-text: #0f172a;
  --color-text-dim: #64748b;
  --color-border: #e2e8f0;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Outfit', sans-serif;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
  color: var(--color-text);
  min-height: 100vh;
  transition: background 0.3s ease, color 0.3s ease;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(15, 52, 96, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* LOGIN PAGE */
.login-container {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
}

.login-card {
  background: rgba(26, 26, 46, 0.9);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 3rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  text-align: center;
  max-width: 450px;
  width: 90%;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.login-card h1 {
  font-family: Impact, sans-serif;
  font-size: 3rem;
  background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-highlight) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
}

.login-card p {
  color: var(--color-text-dim);
  margin-bottom: 2rem;
  font-size: 1.05rem;
}

.discord-login-btn {
  background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 8px 20px rgba(88, 101, 242, 0.4);
}

.discord-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(88, 101, 242, 0.6);
}

.discord-login-btn svg {
  width: 24px;
  height: 24px;
}

.login-info {
  margin-top: 2rem;
  padding: 1.5rem;
  background: rgba(233, 69, 96, 0.1);
  border-radius: 12px;
  border: 1px solid rgba(233, 69, 96, 0.2);
  color: var(--color-text-dim);
  font-size: 0.9rem;
  line-height: 1.6;
}

/* HEADER */
header {
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 2rem;
  margin: 2rem;
  position: relative;
  z-index: 100;
}

[data-theme="light"] header {
  background: rgba(255, 255, 255, 0.9);
}

header h1 {
  font-family: Impact, sans-serif;
  font-size: 3.5rem;
  background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-highlight) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
}

[data-theme="light"] header h1 {
  background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.subtitle {
  text-align: center;
  font-size: 1rem;
  color: var(--color-text-dim);
  font-weight: 400;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 2rem;
}

/* USER PROFILE */
.user-profile {
  position: absolute;
  top: 2rem;
  right: 8rem;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid var(--color-border);
  border-radius: 50px;
  transition: all 0.3s;
}

.user-profile:hover {
  background: rgba(255, 255, 255, 0.1);
}

.user-profile img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid var(--color-highlight);
}

.username {
  font-weight: 600;
  color: var(--color-text);
}

.logout-btn {
  background: rgba(233, 69, 96, 0.2);
  border: 1px solid var(--color-highlight);
  color: var(--color-highlight);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
  margin-left: 8px;
}

.logout-btn:hover {
  background: var(--color-highlight);
  color: white;
}

/* THEME TOGGLE */
.theme-toggle {
  position: absolute;
  top: 2rem;
  right: 2rem;
  width: 60px;
  height: 30px;
  background: var(--color-border);
  border-radius: 15px;
  cursor: pointer;
  transition: background 0.3s;
}

.theme-toggle:hover {
  background: var(--color-highlight);
}

.theme-slider {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

[data-theme="light"] .theme-slider {
  transform: translateX(30px);
}

.theme-icon {
  font-size: 14px;
}

/* NAVIGATION */
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: none !important;
  border: none !important;
  padding: 0 !important;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--color-text);
  cursor: pointer;
  padding: 8px 0;
  background: none !important;
  border: none !important;
  transition: color 0.3s ease;
  user-select: none;
}





.nav-item:hover { background: none !important; transform: none !important; color: var(--color-text) !important; }

.nav-item.active { background: none !important; color: var(--color-text) !important; }

.nav-item.admin-only,
.nav-item.rh-only {
  display: none;
}

body.role-admin .nav-item.admin-only,
body.role-rh .nav-item.admin-only,
body.role-rh .nav-item.rh-only {
  display: block;
}

/* CONTENT CONTAINER */
.content-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}

/* TAB CONTENT */
.tab-content {
  display: none;
  animation: fadeIn 0.5s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* EMPLOYEE CARDS */
.search-container {
  background: transparent;
  padding: 0 0 1rem 0;
  text-align: right;
  margin: 0;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1rem;
}

.search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
  max-width: 600px;
  gap: 0.5rem;
}

.filter-icon {
  width: 24px;
  height: 24px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.filter-icon:hover {
  opacity: 0.7;
}

.filter-select {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: rgba(13, 17, 23, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #e8e8e8;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s;
  outline: none;
  min-width: 200px;
}

.filter-select.active {
  display: block;
}

/* FILTER SELECTOR (comme grade-selector) */
.filter-selector {
  position: relative;
  display: inline-block;
}

.filter-icon-only {
  width: 24px;
  height: 24px;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.2s;
}

.filter-icon-only:hover {
  opacity: 0.7;
  transform: scale(1.1);
}


.filter-selector button {
  padding: 0.75rem 1.25rem;
  background: rgba(13, 17, 23, 0.85);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #e8e8e8;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
}

.filter-selector button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #e94560;
}

.filter-options {
  position: absolute;
  top: 50%;
  left: calc(100% + 0.5rem);
  transform: translateY(-50%) scaleX(0);
  transform-origin: left center;
  background: rgba(13, 17, 23, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 0.5rem;
  max-height: 60px;
  overflow-x: auto;
  overflow-y: hidden;
  display: flex;
  flex-direction: row;
  gap: 0.5rem;
  z-index: 1000;
  white-space: nowrap;
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}

.filter-options.active {
  display: flex;
  transform: translateY(-50%) scaleX(1);
  opacity: 1;
}

.filter-option {
  padding: 0.5rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
  color: #e8e8e8;
  font-size: 0.9rem;
  border-radius: 8px;
  white-space: nowrap;
  flex-shrink: 0;
}

.filter-option:hover {
  background: rgba(233, 69, 96, 0.2);
  color: #e94560;
}


.filter-select:hover {
  border-color: rgba(255,255,255,0.2);
}

.filter-select:focus {
  border-color: #e94560;
  box-shadow: 0 0 15px rgba(233, 69, 96, 0.2);
}

.filter-select option {
  background: #0d1117;
  color: #e8e8e8;
}

.search-input {
  width: 100%;
  flex: 1;
  padding: 0.75rem 1.25rem;
  background: rgba(13, 17, 23, 0.85);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #e8e8e8;
  font-size: 0.95rem;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: #e94560;
  box-shadow: 0 0 15px rgba(233, 69, 96, 0.2);
}

.search-input::placeholder {
  color: var(--color-text-dim);
}

.employee-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.employee-card {
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 16px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.employee-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--color-gold), var(--color-highlight));
  transform: scaleX(0);
  transition: transform 0.3s;
}

.employee-card:hover::before {
  transform: scaleX(1);
}

.employee-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(233, 69, 96, 0.3);
  border-color: var(--color-highlight);
}


.employee-name {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 0.5rem;
}

.employee-grade {
  font-size: 0.95rem;
  color: var(--color-text-dim);
}

/* EMPLOYEE DETAILS MODAL */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 1000;
  padding: 2rem;
  overflow-y: auto;
}

.modal.active {
  display: flex;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s;
}

.modal-content {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(20, 20, 36, 0.98));
  border-radius: 20px;
  padding: 2.5rem;
  width: 90%;
  max-width: 900px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  position: relative;
  animation: modalSlideIn 0.3s ease-out;
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: var(--color-highlight);
  border-radius: 10px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: #ff5577;
}

.close-btn {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 36px;
  height: 36px;
  background: rgba(233, 69, 96, 0.2);
  border: 1px solid var(--color-highlight);
  border-radius: 50%;
  color: var(--color-highlight);
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.close-btn:hover {
  background: var(--color-highlight);
  color: white;
  transform: rotate(90deg);
}

.modal-content h2 {
  font-size: 2rem;
  margin-bottom: 2rem;
  color: var(--color-text);
}

.details-table {
  width: 100%;
  border-collapse: collapse;
}

.details-table tr {
  border-bottom: 1px solid var(--color-border);
}

.details-table td {
  padding: 1rem;
  color: var(--color-text);
}

.details-table td:first-child {
  font-weight: 600;
  color: var(--color-text-dim);
  width: 200px;
}

/* DIPLOME BUTTONS */
.diplome-btn {
  background: rgba(212, 175, 55, 0.2);
  border: 1px solid var(--color-gold);
  color: var(--color-gold);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
  margin: 0.25rem;
  display: inline-block;
}

.diplome-btn:hover {
  background: var(--color-gold);
  color: var(--color-bg);
}

/* GRADE SELECTOR */
.grade-selector {
  position: relative;
  display: inline-block;
  width: 100%;
}

.grade-selector button {
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  color: var(--color-text);
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
}

.grade-selector button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--color-highlight);
}

.grade-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(26, 26, 46, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  margin-top: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  display: none;
  z-index: 10;
}

.grade-options.active {
  display: block;
}

.grade-option {
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--color-text);
}

.grade-option:hover {
  background: rgba(233, 69, 96, 0.2);
  color: var(--color-highlight);
}

/* STATUS SELECTOR (m√™me style que grade-selector) */
.status-selector {
  position: relative;
  display: inline-block;
  min-width: 200px;
}

.status-selector button {
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  color: var(--color-text);
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
  font-size: 1rem;
  font-weight: 600;
}

.status-selector button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--color-highlight);
}

.status-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(26, 26, 46, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  margin-top: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  display: none;
  z-index: 10;
}

.status-options.active {
  display: block;
}

.status-option {
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--color-text);
}

.status-option:hover {
  background: rgba(233, 69, 96, 0.2);
  color: var(--color-highlight);
}

/* COMMENT BADGE */
.comment-badge {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  width: 24px;
  height: 24px;
  cursor: help;
  z-index: 10;
}

.comment-badge svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
}

.comment-badge img {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2)) brightness(2) contrast(1.5);
  background: transparent !important;
  mix-blend-mode: lighten;
  isolation: isolate;
}

.comment-badge .tooltip {
  display: none;
  position: fixed;
  padding: 0.75rem 1rem;
  background: rgba(26, 26, 46, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  color: var(--color-text);
  font-size: 0.85rem;
  line-height: 1.4;
  white-space: pre-wrap;
  max-width: 300px;
  min-width: 200px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 10000;
  pointer-events: none;
}

.comment-badge:hover .tooltip {
  display: block;
}

/* CONTEXT MENU */
#contextMenu {
  position: fixed;
  background: rgba(26, 26, 46, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 0.5rem 0;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 10000;
  display: none;
}

.context-menu-item {
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--color-text);
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.context-menu-item:hover {
  background: rgba(233, 69, 96, 0.2);
  color: var(--color-highlight);
}

.context-menu-separator {
  height: 1px;
  background: var(--color-border);
  margin: 0.25rem 0;
}


/* TOAST */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  padding: 1rem 1.5rem;
  background: rgba(26, 26, 46, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  color: var(--color-text);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  z-index: 10000;
  animation: slideInRight 0.3s;
  display: none;
}

.toast.show {
  display: block;
}

.toast.success {
  border-color: #4ade80;
  background: rgba(74, 222, 128, 0.1);
}

.toast.error {
  border-color: var(--color-highlight);
  background: rgba(233, 69, 96, 0.1);
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* IFRAME CONTAINER */
.iframe-container {
  width: 100%;
  height: calc(100vh - 250px);
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 16px;
  overflow: hidden;
}

.iframe-container iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* INFO MESSAGE */
.info-message {
  text-align: center;
  padding: 3rem;
  color: var(--color-text-dim);
  font-size: 1.1rem;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  header h1 {
    font-size: 2.5rem;
  }

  .user-profile {
    position: static;
    margin: 1rem auto 0;
    width: fit-content;
  }

  .employee-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
  background: linear-gradient(145deg, rgba(26, 26, 46, 0.98), rgba(20, 20, 36, 0.98));
  border-radius: 20px;
  padding: 2.5rem;
  width: 90%;
  max-width: 900px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  position: relative;
  animation: modalSlideIn 0.3s ease-out;
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: var(--color-highlight);
  border-radius: 10px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: #ff5577;
}
}


/* Retirer le padding du container pour l'onglet factures */
.content-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}

#tab-factures .content-container,
#tab-factures.content-container {
  padding: 0;
  max-width: 100%;
}

/* ==================== IFRAME FULLSCREEN ==================== */
#tab-factures {
  padding: 0 !important;
  margin: 0 !important;
}

.iframe-container {
  width: 100%;
  height: calc(100vh - 250px);
  min-height: 800px;
  background: transparent;
  border: none;
  overflow: hidden;
  margin: 0;
  padding: 0;
  border-radius: 0;
}

.iframe-container iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
  overflow: auto;
}
  
/* Navigation avec soulignement */
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: none !important;
  border: none !important;
  padding: 0 !important;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--color-text);
  cursor: pointer;
  padding: 8px 0;
  background: none !important;
  border: none !important;
  transition: color 0.3s ease;
  user-select: none;
}

.nav-item:hover { background: none !important; transform: none !important; color: var(--color-text) !important; }

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: var(--color-highlight);
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after {
  width: 100%;
}


/* Navigation propre */
header .navigation { display: flex; justify-content: center; gap: 50px; margin-top: 20px; flex-wrap: wrap; }
header .nav-item { position: relative; font-weight: 600; font-size: 1.05rem; color: #fff; cursor: pointer; padding: 8px 0; user-select: none; background: none !important; }
header .nav-item::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0%; height: 3px; background: #fff; border-radius: 5px; transition: width 0.3s ease; }
header .nav-item.active::after, header .nav-item:hover::after { width: 100%; }

/* ========================================
   DARK MODE - LAYOUT HORIZONTAL
   Style inspir√© des images
   ======================================== */

/* MAIN APP LAYOUT */
#mainApp {
  display: flex !important;
  flex-direction: column;
  height: 100vh;
  background: url('https://i.postimg.cc/L5RzN6nF/bgcolor-Logo-Paleto-Garage.png') center/cover fixed !important;
  position: relative;
  padding: 70px 130px;
  box-sizing: border-box;
  overflow: hidden;
}

/* Logo watermark centr√© */
#mainApp::before {
  content: '';
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 600px;
  height: 600px;
  background: url('https://i.postimg.cc/2ywnJRZq/logo-flashback-fa-Logo-Paleto-Garage.png') no-repeat center/contain;
  opacity: 0.35;
  z-index: 0;
  pointer-events: none;
}

body {
  background: url('https://i.postimg.cc/L5RzN6nF/bgcolor-Logo-Paleto-Garage.png') center/cover fixed !important;
}

/* HEADER HORIZONTAL */
.header-horizontal {
  background: transparent;
  backdrop-filter: none;
  padding: 1.5rem 3rem;
  border-bottom: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 30px;
  left: 70px;
  right: 70px;
  z-index: 100;
  box-shadow: none;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.logo-image {
  height: 50px;
  width: auto;
  display: block;
}

.theme-toggle-header {
  width: 50px;
  height: 26px;
  background: rgba(255,255,255,0.1);
  border-radius: 13px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  padding: 0 4px;
  border: 1px solid rgba(255,255,255,0.2);
}

.theme-toggle-header:hover {
  background: rgba(255,255,255,0.15);
}

.theme-toggle-header .theme-icon {
  font-size: 0.9rem;
}

.header-center {
  flex: 1;
  display: flex;
  justify-content: flex-end;
  padding-right: 3rem;
}

.header-nav {
  display: flex;
  gap: 2.5rem;
  align-items: center;
}

.header-nav-item {
  color: #e8e8e8;
  text-decoration: none;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  padding: 0.5rem 0;
  border: none;
  background: none;
  font-family: "alfarn-2", "Outfit", sans-serif;
}

.header-nav-item::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 50%;
  right: 50%;
  height: 2px;
  background: white;
  transition: all 0.3s ease;
}

.header-nav-item:hover::after {
  left: 0;
  right: 0;
}

.header-nav-item.active::after {
  left: 0;
  right: 0;
}

.header-nav-item:hover {
  color: white;
}

.header-nav-item.active {
  color: white;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.user-info-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.user-avatar-header {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.2);
}

.user-name-header {
  font-weight: 600;
  color: white;
  font-size: 0.95rem;
}

.logout-btn-header {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  color: white;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
}

.logout-btn-header:hover {
  background: #e94560;
  border-color: #e94560;
}

/* MAIN WRAPPER */
.main-wrapper {
  flex: 1;
  display: flex;
  position: relative;
  padding-top: 100px;
  overflow: hidden;
}

/* USER BADGE FIXE EN BAS √Ä GAUCHE */
.user-badge-fixed {
  position: fixed;
  bottom: calc(2rem + 32px);
  left: calc(2rem + 70px);
  z-index: 200;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  writing-mode: vertical-rl;
  transform: rotate(180deg);
}

.user-badge-line {
  width: 3px;
  height: 80px;
  background: white;
}

.user-badge-text {
  font-size: 1.75rem;
  font-weight: 700;
  color: white;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-family: "alfarn-2", "Outfit", sans-serif;
}

/* CONTENT AREA */
.content-container {
  flex: 1;
  padding: 2rem 3rem 2rem 8rem !important;
  overflow-y: overlay;
  background: transparent;
  max-width: none !important;
  position: relative;
  z-index: 1;
  -webkit-mask-image: linear-gradient(to bottom, 
    transparent 0%, 
    black 40px,
    black 100%
  );
  mask-image: linear-gradient(to bottom, 
    transparent 0%, 
    black 40px,
    black 100%
  );
}

/* SCROLLBAR OVERLAY */
.content-container::-webkit-scrollbar {
  width: 12px;
}

.content-container::-webkit-scrollbar-track {
  background: transparent;
}

.content-container::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.4);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: content-box;
}

.content-container::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.6);
  border: 2px solid transparent;
  background-clip: content-box;
}

/* Firefox scrollbar */
.content-container {
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.4) transparent;
}

/* CARDS DARK MODE */
.employee-card {
  background: rgba(13, 17, 23, 0.85) !important;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1) !important;
  color: #e8e8e8 !important;
  transition: all 0.3s ease;
}

.employee-card:hover {
  border-color: #e94560 !important;
  box-shadow: 0 8px 24px rgba(233, 69, 96, 0.3) !important;
  background: rgba(13, 17, 23, 0.95) !important;
}

/* SYST√àME DE COULEURS DYNAMIQUES BAS√â SUR LES SANCTIONS */
.employee-card.card-status-green {
  border: 2px solid #22c55e !important;
  box-shadow: 0 0 15px rgba(34, 197, 94, 0.3) !important;
}

.employee-card.card-status-green:hover {
  border-color: #16a34a !important;
  box-shadow: 0 0 25px rgba(34, 197, 94, 0.5) !important;
}

.employee-card.card-status-yellow {
  border: 2px solid #eab308 !important;
  box-shadow: 0 0 15px rgba(234, 179, 8, 0.3) !important;
}

.employee-card.card-status-yellow:hover {
  border-color: #ca8a04 !important;
  box-shadow: 0 0 25px rgba(234, 179, 8, 0.5) !important;
}

.employee-card.card-status-orange {
  border: 2px solid #f97316 !important;
  box-shadow: 0 0 15px rgba(249, 115, 22, 0.3) !important;
}

.employee-card.card-status-orange:hover {
  border-color: #ea580c !important;
  box-shadow: 0 0 25px rgba(249, 115, 22, 0.5) !important;
}

.employee-card.card-status-red {
  border: 2px solid #ef4444 !important;
  box-shadow: 0 0 15px rgba(239, 68, 68, 0.3) !important;
}

.employee-card.card-status-red:hover {
  border-color: #dc2626 !important;
  box-shadow: 0 0 25px rgba(239, 68, 68, 0.5) !important;
}

/* TITRES DE SECTIONS */
.employee-section-title {
  color: white;
  font-size: 1.15rem;
  font-weight: 600;
  font-family: "alfarn-2", "Outfit", sans-serif;
  margin: 2.5rem 0 1rem 0;
  padding: 0;
  border: none;
  text-align: left;
  text-transform: uppercase;
  letter-spacing: 2px;
  grid-column: 1 / -1;
  width: 100%;
}

.employee-section-title:first-of-type {
  margin-top: 0.5rem;
}

.employee-name {
  color: white !important;
}

.employee-grade {
  color: #a0a0a8 !important;
}

/* INFO MESSAGE DARK */
.info-message {
  background: rgba(13, 17, 23, 0.85) !important;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1) !important;
  color: #e8e8e8 !important;
}

.info-message h2 {
  color: white !important;
}

.info-message p {
  color: #e8e8e8 !important;
}

/* SEARCH INPUT DARK */
.search-input {
  background: #0f1419 !important;
  border: 1px solid rgba(255,255,255,0.1) !important;
  color: #e8e8e8 !important;
}

.search-input::placeholder {
  color: #a0a0a8 !important;
}

.search-input:focus {
  border-color: #e94560 !important;
  box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2) !important;
}

/* MODAL DARK */
.modal {
  background: rgba(0,0,0,0.8) !important;
}

.modal-content {
  background: #0d1117 !important;
  border: 1px solid rgba(255,255,255,0.1) !important;
  color: #e8e8e8 !important;
}

.modal-content h2 {
  color: white !important;
}

.details-table {
  color: #e8e8e8 !important;
}

.details-table th {
  background: #0f1419 !important;
  color: white !important;
}

.details-table td {
  border-color: rgba(255,255,255,0.1) !important;
}

.close-btn {
  background: rgba(255,255,255,0.1) !important;
  color: white !important;
}

.close-btn:hover {
  background: #e94560 !important;
}

/* TAB CONTENT */
.tab-content {
  color: #e8e8e8;
}

.tab-content h2 {
  color: white !important;
}

/* TOAST DARK */
.toast {
  background: #0d1117 !important;
  border: 1px solid rgba(255,255,255,0.1) !important;
  color: #e8e8e8 !important;
}

/* STATUS BADGES */
.status-badge {
  font-weight: 600;
}

/* COMMENT BADGE */
.comment-badge {
  background: #e94560 !important;
}

.comment-badge .tooltip {
  background: #0d1117 !important;
  border: 1px solid rgba(255,255,255,0.2) !important;
}

/* CONTEXT MENU DARK */
.context-menu {
  background: #0d1117 !important;
  border: 1px solid rgba(255,255,255,0.2) !important;
}

.context-menu-item {
  color: #e8e8e8 !important;
}

.context-menu-item:hover {
  background: rgba(255,255,255,0.1) !important;
}

/* IFRAME CONTAINER */
.iframe-container {
  background: #0d1117;
  border-radius: 0.75rem;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1);
}

</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-container" id="loginContainer">
  <div class="login-card">
    <h1>PALETO GARAGE</h1>
    <p>Connectez-vous avec Discord pour acc√©der au syst√®me de gestion</p>
    
    <button class="discord-login-btn" onclick="loginWithDiscord()">
      <svg viewBox="0 0 127.14 96.36" fill="currentColor">
        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
      </svg>
      Se connecter avec Discord
    </button>

    <div class="login-info">
      <strong>‚ÑπÔ∏è Information</strong><br>
      Votre ID Discord doit √™tre dans la liste des employ√©s pour acc√©der √† cette application.
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
  <!-- HEADER HORIZONTAL -->
  <div class="header-horizontal">
    <div class="header-left">
      <img class="logo-image" src="https://i.postimg.cc/020tghsY/logo-paleto-garage-Logo-Paleto-Garage.png" alt="PALETO GARAGE">
      <div class="theme-toggle-header" onclick="toggleTheme()" title="Changer de th√®me">
        <span class="theme-icon">üåô</span>
      </div>
    </div>
    
    <div class="header-center">
      <nav class="header-nav" id="mainNavigation">
        <!-- Navigation g√©n√©r√©e dynamiquement -->
      </nav>
    </div>
  </div>

  <!-- MAIN WRAPPER -->
  <div class="main-wrapper">
    <!-- CONTENT AREA -->
    <div class="content-container">
    <!-- ACCUEIL -->
    <div class="tab-content active" id="tab-accueil">
      <div class="info-message">
        <h2>üëã Bienvenue <span id="welcomeName"></span></h2>
        <p style="margin-top: 1rem;">Utilisez le menu ci-dessus pour naviguer entre les diff√©rentes sections.</p>
        <div style="margin-top: 2rem; padding: 2rem; background: rgba(233, 69, 96, 0.1); border-radius: 16px; border: 1px solid var(--color-highlight);">
          <strong>Vos permissions :</strong>
          <p id="userPermissions" style="margin-top: 1rem;"></p>
        </div>
      </div>
    </div>

    <!-- EMPLOY√âS -->
    <div class="tab-content" id="tab-employes">
      <div class="search-container">
        <div class="search-wrapper">
          <div class="filter-selector">
            <img src="https://i.postimg.cc/28dkdrB2/filtre-Logo-Paleto-Garage.png" 
                 alt="Filtrer" 
                 class="filter-icon-only"
                 onclick="toggleFilterOptions('filterEmployees')">
            <div class="filter-options" id="filterEmployees">
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'tous', 'Tous')">Tous</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'actifs', 'Actifs')">Actifs</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'licencies', 'Licenci√©s')">Licenci√©s</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'patron', 'Patron')">Patron</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'copatron', 'Co Patron')">Co Patron</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'drh', 'DRH')">DRH</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'rh', 'RH')">RH</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'mecano', 'M√©cano')">M√©cano</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'apprenti', 'Apprenti')">Apprenti</div>
              <div class="filter-option" onclick="selectFilter('filterEmployees', 'stagiaire', 'Stagiaire')">Stagiaire</div>
            </div>
          </div>
          <input type="text" class="search-input" id="searchBar" placeholder="Rechercher un employ√©...">
        </div>
      </div>
      <div class="employee-grid" id="employeeList"></div>
    </div>

    <!-- RECRUTEMENT -->
    <div class="tab-content" id="tab-recrutement">
      <div class="search-container">
        <div class="search-wrapper">
          <div class="filter-selector">
            <img src="https://i.postimg.cc/28dkdrB2/filtre-Logo-Paleto-Garage.png" 
                 alt="Filtrer" 
                 class="filter-icon-only"
                 onclick="toggleFilterOptions('filterRecruits')">
            <div class="filter-options" id="filterRecruits">
              <div class="filter-option" onclick="selectFilter('filterRecruits', 'tous', 'Tous les candidats')">Tous les candidats</div>
              <div class="filter-option" onclick="selectFilter('filterRecruits', 'attente', 'En attente')">En attente</div>
              <div class="filter-option" onclick="selectFilter('filterRecruits', 'accepte', 'Accept√©s')">Accept√©s</div>
              <div class="filter-option" onclick="selectFilter('filterRecruits', 'refuse', 'Refus√©s')">Refus√©s</div>
              <div class="filter-option" onclick="selectFilter('filterRecruits', 'blacklist', 'Blacklist')">Blacklist</div>
            </div>
          </div>
          <input type="text" class="search-input" id="searchBarRecruit" placeholder="Rechercher un candidat...">
        </div>
      </div>
      <div class="employee-grid" id="recruitList"></div>
    </div>

    <!-- FACTURES -->
    <div class="tab-content" id="tab-factures">
      <div class="iframe-container">
        <iframe src="Facture_Paleto.html"></iframe>
      </div>
    </div>

    <!-- ABSENCE -->
    <div class="tab-content" id="tab-absence">
      <div class="info-message">
        <h2>üìÖ Gestion des absences</h2>
        <p style="margin-top: 1rem;">Cette section est en cours de d√©veloppement.</p>
      </div>
    </div>
    <!-- PROFIL -->
    <div class="tab-content" id="tab-profil">
      <div class="info-message" id="profilContent">
        <h2>üë§ Mon Profil</h2>
        <p style="margin-top: 1rem;">Chargement...</p>
      </div>
    </div>

    <!-- PARTENARIATS -->
    <div class="tab-content" id="tab-partenariats">
      <div class="info-message">
        <h2>ü§ù Partenariats</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- BANQUE -->
    <div class="tab-content" id="tab-banque">
      <div class="info-message">
        <h2>üè¶ Banque</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- COMPTA -->
    <div class="tab-content" id="tab-compta">
      <div class="info-message">
        <h2>üìä Comptabilit√©</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- LOGS -->
    <div class="tab-content" id="tab-logs">
      <div class="info-message">
        <h2>üìú Historique</h2>
        <div id="logsContainer" style="margin-top: 2rem;">
          <p>Chargement des logs...</p>
        </div>
      </div>
    </div>
    <div class="tab-content" id="tab-profil"><div class="info-message"><h2>üë§ Profil</h2></div></div>

    </div> <!-- fin content-container -->
  </div> <!-- fin main-wrapper -->

  <!-- USER BADGE FIXE BAS GAUCHE -->
  <div class="user-badge-fixed">
    <div class="user-badge-line"></div>
    <div class="user-badge-text" id="userBadgeText"></div>
  </div>

</div> <!-- fin mainApp -->

<!-- EMPLOYEE DETAILS MODAL -->
<div class="modal" id="employeeModal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">‚úñ</div>
    <h2 id="modalTitle"></h2>
    <table class="details-table" id="modalContent"></table>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ==================== CONFIG ====================
const BACKEND_URL = "https://paleto-backend.vercel.app";
const SHEET_ID = "17ZntDHZ8olidnCM1pig311AcjawM4l6HoRxSYFP7KGw";
const API_KEY = "AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E";
const SHEET_EMPLOYEES = "Info Employ√©";
const SHEET_RECRUITMENT = "Formulaire Info ";
const LOGS_SHEET_ID = "19YnTEHpGQSoqMbInvK29HWsPBXzoexYcqzRVDJjKsyI";

const GRADES = [
  "Patron", "Co Patron", "DRH", "RH", "Responsable D'atelier",
  "Chef d'atelier", "Confirm√©", "M√©cano", "Apprenti", "Stagiaire"
];
const GRADE_HIERARCHY = ["Patron","Co Patron","DRH","RH","Responsable D'atelier","Responsable Evenementiel","Asst Evenemtiel","Chef d'atelier","Confirm√©","M√©cano","Apprenti","Stagiaire"];
function getGradeLevel(grade) { const idx = GRADE_HIERARCHY.indexOf(grade); return idx === -1 ? 999 : idx; }
function canAssignGrade(userGrade, targetGrade) { return getGradeLevel(targetGrade) > getGradeLevel(userGrade); }


let currentUser = null;
let allEmployees = [];
let filteredEmployees = [];
let allRecruits = [];
let logsAutoRefreshInterval = null;
let filteredRecruits = [];

// ==================== AUTH ====================
function loginWithDiscord() {
  console.log('üîó Connexion Discord...');
  window.location.href = `${BACKEND_URL}/auth/discord`;
}

async function checkAuth() {
  try {
    console.log('üîç V√©rification auth...');
    const response = await fetch(`${BACKEND_URL}/api/check-auth`, {
      credentials: 'include'
    });
    
    const data = await response.json();
    console.log('üì• R√©ponse:', data);
    
    if (data.authenticated) {
      currentUser = data.user;
      showApp();
    } else {
      showLogin();
    }
  } catch (error) {
    console.error('‚ùå Erreur auth:', error);
    showLogin();
  }
}

async function logout() {
  try {
    await fetch(`${BACKEND_URL}/api/logout`, {
      method: 'POST',
      credentials: 'include'
    });
    currentUser = null;
    showLogin();
    showToast('üëã D√©connexion r√©ussie', 'success');
  } catch (error) {
    console.error('‚ùå Erreur logout:', error);
  }
}

function showLogin() {
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

function showApp() {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  // Mettre le pr√©nom et nom dans le badge user fixe
  const fullName = currentUser.employeeName || currentUser.username;
  document.getElementById('userBadgeText').textContent = fullName;
  
  document.getElementById('welcomeName').textContent = fullName;
  
  const permissions = {
    'admin': 'Administrateur - Acc√®s complet',
    'rh': 'Ressources Humaines - Acc√®s aux employ√©s et recrutement',
    'employee': 'Employ√© - Consultation uniquement',
    'visitor': 'Visiteur - Acc√®s limit√©'
  };
  document.getElementById('userPermissions').textContent = permissions[currentUser.role];
  
  document.body.className = `role-${currentUser.role}`;
  logAction("Connexion au syst√®me");
  
  buildNavigation();
  
  // Charger avec des d√©lais pour √©viter l'erreur 429
  setTimeout(() => loadProfilPage(), 100);
  setTimeout(() => loadLogsPage(), 2000);
  
  
  // Charger employ√©s et recrues avec d√©lais
  setTimeout(() => {
    loadEmployees();
  }, 1000);
  
  setTimeout(() => {
    loadRecruits();
  }, 3000);
}

// ==================== NAVIGATION ====================
function switchTab(tabName) {
  // D√©sactiver tous les header-nav-items
  document.querySelectorAll('.header-nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Activer le bon header-nav-item
  document.querySelectorAll('.header-nav-item').forEach(item => {
    const onclick = item.getAttribute('onclick');
    if (onclick && onclick.includes("'" + tabName + "'")) {
      item.classList.add('active');
    }
  });
  
  // Masquer tous les tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Afficher le bon tab
  const targetTab = document.getElementById('tab-' + tabName);
  if (targetTab) {
    targetTab.classList.add('active');
  }
}

// ==================== THEME ====================

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.querySelector('.theme-icon').textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

// ==================== EMPLOYEES ====================
async function loadEmployees() {
  const list = document.getElementById('employeeList');
  
  try {
    list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
    
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_EMPLOYEES)}?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.values) {
      list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
      return;
    }

    const rows = data.values;
    let headerIndex = -1;
    
    for (let i = 0; i < rows.length; i++) {
      if (rows[i] && rows[i].some(cell => 
        cell && cell.toString().includes("Pr√©nom / Nom")
      )) {
        headerIndex = i;
        break;
      }
    }
    
    if (headerIndex === -1) {
      list.innerHTML = '<div class="info-message">‚ùå En-t√™te introuvable</div>';
      return;
    }

    const dataRows = rows.slice(headerIndex + 1);
    const unique = new Set();

    allEmployees = dataRows
      .filter(row => {
        const nom = row[2] ? row[2].toString().trim() : '';
        return nom && nom !== "Pr√©nom / Nom" && nom !== "D√©mission/Licenciement";
      })
      .map(r => ({
        id: r[1] ? r[1].toString().trim() : '',
        nom: r[2] ? r[2].toString().trim() : '',
        rib: r[3] ? r[3].toString().trim() : '',
        grade: r[4] ? r[4].toString().trim() : '',
        tel: r[5] ? r[5].toString().trim() : '',
        discord: r[6] ? r[6].toString().trim() : '',
        gmail: r[8] ? r[8].toString().trim() : '',
        diplome: r[9] ? r[9].toString().trim() : '',
        entree: r[10] ? r[10].toString().trim() : '',
        sortie: r[11] ? r[11].toString().trim() : '',
        sanction: r[12] ? r[12].toString().trim() : '',
        retrait: r[13] ? r[13].toString().trim() : ''
      }))
      .filter(e => {
        if (!e.nom || unique.has(e.nom)) return false;
        unique.add(e.nom);
        return true;
      });

    filteredEmployees = [...allEmployees];
    displayEmployees(filteredEmployees);

  } catch (error) {
    list.innerHTML = `<div class="info-message">‚ùå Erreur: ${error.message}</div>`;
  }
}

function displayEmployees(employees) {
  const list = document.getElementById('employeeList');
  list.innerHTML = '';

  if (employees.length === 0) {
    list.innerHTML = '<div class="info-message">Aucun employ√© trouv√©</div>';
    return;
  }

  // S√©parer les employ√©s actifs et les licenci√©s/d√©missionn√©s
  const actifs = [];
  const licencies = [];
  
  employees.forEach(emp => {
    const sanctionLower = (emp.sanction || '').toLowerCase();
    if (sanctionLower.includes('licenciement') || sanctionLower.includes('d√©mission') || sanctionLower.includes('demission')) {
      licencies.push(emp);
    } else {
      actifs.push(emp);
    }
  });
  
  // Trier les actifs par grade
  actifs.sort((a, b) => getGradeLevel(a.grade) - getGradeLevel(b.grade));
  
  // Trier les licenci√©s par grade aussi
  licencies.sort((a, b) => getGradeLevel(a.grade) - getGradeLevel(b.grade));
  
  // Afficher les employ√©s actifs
  if (actifs.length > 0) {
    const titleActifs = document.createElement('div');
    titleActifs.className = 'employee-section-title';
    titleActifs.textContent = 'Employ√©';
    list.appendChild(titleActifs);
    
    actifs.forEach((emp, index) => {
      const card = document.createElement('div');
      card.className = 'employee-card';
      
      // Syst√®me de couleurs dynamiques bas√© sur les sanctions
      const statusClass = getSanctionStatusClass(emp.sanction);
      if (statusClass) {
        card.classList.add(statusClass);
      }
      
      card.innerHTML = `
        <div class="employee-name">${emp.nom}</div>
        <div class="employee-grade">${emp.grade || 'Sans grade'}</div>
      `;
      
      // Trouver l'index dans le tableau original pour showEmployeeDetails
      const originalIndex = employees.indexOf(emp);
      card.onclick = () => showEmployeeDetails(originalIndex);
      list.appendChild(card);
    });
  }
  
  // Afficher les licenci√©s/d√©missionn√©s
  if (licencies.length > 0) {
    const titleLicencies = document.createElement('div');
    titleLicencies.className = 'employee-section-title';
    titleLicencies.textContent = 'Licenciement / D√©mission';
    list.appendChild(titleLicencies);
    
    licencies.forEach((emp, index) => {
      const card = document.createElement('div');
      card.className = 'employee-card';
      
      // Syst√®me de couleurs dynamiques bas√© sur les sanctions
      const statusClass = getSanctionStatusClass(emp.sanction);
      if (statusClass) {
        card.classList.add(statusClass);
      }
      
      card.innerHTML = `
        <div class="employee-name">${emp.nom}</div>
        <div class="employee-grade">${emp.grade || 'Sans grade'}</div>
      `;
      
      // Trouver l'index dans le tableau original pour showEmployeeDetails
      const originalIndex = employees.indexOf(emp);
      card.onclick = () => showEmployeeDetails(originalIndex);
      list.appendChild(card);
    });
  }
}

// Fonction pour d√©terminer la couleur selon les sanctions
function getSanctionStatusClass(sanction) {
  if (!sanction || sanction === '-' || sanction === '') {
    return null; // Pas de sanction = PAS de contour
  }
  
  const sanctionLower = sanction.toLowerCase();
  
  // Licenciement ou D√©mission = ROUGE
  if (sanctionLower.includes('licenciement') || sanctionLower.includes('d√©mission') || sanctionLower.includes('demission')) {
    return 'card-status-red';
  }
  
  // Avertissement 2 = ORANGE
  if (sanctionLower.includes('avertissement 2') || sanctionLower.includes('avertissement2')) {
    return 'card-status-orange';
  }
  
  // Avertissement 1 = JAUNE
  if (sanctionLower.includes('avertissement 1') || sanctionLower.includes('avertissement1') || sanctionLower.includes('avertissement')) {
    return 'card-status-yellow';
  }
  
  // Par d√©faut pas de contour
  return null;
}

// Fonction pour les couleurs des recrutements
function getRecruitStatusClass(statut) {
  if (!statut) {
    return null;
  }
  
  const statutLower = statut.toLowerCase();
  
  // Accept√© = VERT
  if (statutLower.includes('accept√©') || statutLower.includes('accepte')) {
    return 'card-status-green';
  }
  
  // Refus√© = ROUGE
  if (statutLower.includes('refus√©') || statutLower.includes('refuse')) {
    return 'card-status-red';
  }
  
  // En attente = PAS de contour
  return null;
}

// Fonctions de filtrage
function filterEmployeesByType() {
  const filterValue = currentFilterEmployees;
  const searchTerm = document.getElementById('searchBar').value.toLowerCase();
  
  let filtered = allEmployees;
  
  // Appliquer le filtre
  if (filterValue === 'actifs') {
    filtered = filtered.filter(emp => {
      const sanctionLower = (emp.sanction || '').toLowerCase();
      return !sanctionLower.includes('licenciement') && !sanctionLower.includes('d√©mission') && !sanctionLower.includes('demission');
    });
  } else if (filterValue === 'licencies') {
    filtered = filtered.filter(emp => {
      const sanctionLower = (emp.sanction || '').toLowerCase();
      return sanctionLower.includes('licenciement') || sanctionLower.includes('d√©mission') || sanctionLower.includes('demission');
    });
  } else if (filterValue === 'patron') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase().includes('patron') && !(emp.grade || '').toLowerCase().includes('co'));
  } else if (filterValue === 'copatron') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase().includes('co patron'));
  } else if (filterValue === 'drh') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase() === 'drh');
  } else if (filterValue === 'rh') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase() === 'rh');
  } else if (filterValue === 'mecano') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase().includes('m√©cano'));
  } else if (filterValue === 'apprenti') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase().includes('apprenti'));
  } else if (filterValue === 'stagiaire') {
    filtered = filtered.filter(emp => (emp.grade || '').toLowerCase().includes('stagiaire'));
  }
  
  // Appliquer la recherche
  if (searchTerm) {
    filtered = filtered.filter(emp => 
      (emp.nom || '').toLowerCase().includes(searchTerm) ||
      (emp.grade || '').toLowerCase().includes(searchTerm)
    );
  }
  
  filteredEmployees = filtered;
  displayEmployees(filteredEmployees);
}

// Fonction pour toggle le dropdown de filtre
// Variables globales pour les filtres
let currentFilterEmployees = 'tous';
let currentFilterRecruits = 'tous';

function toggleFilterOptions(optionsId) {
  const options = document.getElementById(optionsId);
  options.classList.toggle('active');
  
  // Fermer si on clique ailleurs
  if (options.classList.contains('active')) {
    setTimeout(() => {
      document.addEventListener('click', function closeOptions(e) {
        if (!e.target.closest('.filter-selector')) {
          options.classList.remove('active');
          document.removeEventListener('click', closeOptions);
        }
      });
    }, 100);
  }
}

function selectFilter(filterId, value, label) {
  const labelElement = document.getElementById(filterId + 'Label');
  labelElement.textContent = label;
  
  const options = document.getElementById(filterId);
  options.classList.remove('active');
  
  if (filterId === 'filterEmployees') {
    currentFilterEmployees = value;
    filterEmployeesByType();
  } else if (filterId === 'filterRecruits') {
    currentFilterRecruits = value;
    filterRecruitsByStatus();
  }
}

function filterRecruitsByStatus() {
  const filterValue = currentFilterRecruits;
  const searchTerm = document.getElementById('searchBarRecruit').value.toLowerCase();
  
  let filtered = allRecruits;
  
  // Appliquer le filtre
  if (filterValue === 'attente') {
    filtered = filtered.filter(rec => {
      const statutLower = (rec.statut || '').toLowerCase();
      return !statutLower.includes('accept√©') && !statutLower.includes('accepte') && 
             !statutLower.includes('refus√©') && !statutLower.includes('refuse') &&
             !statutLower.includes('blacklist');
    });
  } else if (filterValue === 'accepte') {
    filtered = filtered.filter(rec => {
      const statutLower = (rec.statut || '').toLowerCase();
      return statutLower.includes('accept√©') || statutLower.includes('accepte');
    });
  } else if (filterValue === 'refuse') {
    filtered = filtered.filter(rec => {
      const statutLower = (rec.statut || '').toLowerCase();
      return statutLower.includes('refus√©') || statutLower.includes('refuse');
    });
  } else if (filterValue === 'blacklist') {
    filtered = filtered.filter(rec => {
      const statutLower = (rec.statut || '').toLowerCase();
      return statutLower.includes('blacklist');
    });
  }
  
  // Appliquer la recherche
  if (searchTerm) {
    filtered = filtered.filter(rec => 
      (rec.nom || '').toLowerCase().includes(searchTerm)
    );
  }
  
  filteredRecruits = filtered;
  displayRecruits(filteredRecruits);
}

function showEmployeeDetails(index) {
  const emp = filteredEmployees[index];
  const modal = document.getElementById('employeeModal');
  const title = document.getElementById('modalTitle');
  const content = document.getElementById('modalContent');
  
  title.textContent = `üë§ ${emp.nom}`;
  
  let diplomeHTML = '<em>Aucun dipl√¥me</em>';
  if (emp.diplome) {
    const links = emp.diplome.split(/\s+/).filter(l => l.startsWith('http'));
    if (links.length > 0) {
      diplomeHTML = links.map((link, i) => {
        const label = links.length === 1 ? 'Dipl√¥me' : `Dipl√¥me ${i + 1}`;
        return `<button class="diplome-btn" onclick="window.open('${link}', '_blank')">üéì ${label}</button>`;
      }).join('');
    }
  }
  
  let gradeHTML = emp.grade;
  if (currentUser.role === 'admin') {
    gradeHTML = `
      <div class="grade-selector">
        <button onclick="toggleGradeOptions(event)">${emp.grade || 'S√©lectionner'}</button>
        <div class="grade-options">
          ${GRADES.map(g => `<div class="grade-option" onclick="updateGrade('${emp.id}', '${g}')">${g}</div>`).join('')}
        </div>
      </div>
    `;
  }
  
  content.innerHTML = `
    <tr><td>ID Unique</td><td>${emp.id || '-'}</td></tr>
    <tr><td>RIB</td><td>${emp.rib || '-'}</td></tr>
    <tr><td>Grade</td><td>${gradeHTML}</td></tr>
    <tr><td>T√©l√©phone</td><td>${emp.tel || '-'}</td></tr>
    <tr><td>Discord</td><td>${emp.discord || '-'}</td></tr>
    <tr><td>Gmail</td><td>${emp.gmail || '-'}</td></tr>
    <tr><td>üéì Dipl√¥me</td><td>${diplomeHTML}</td></tr>
    <tr><td>Date d'entr√©e</td><td>${emp.entree || '-'}</td></tr>
    <tr><td>Date de sortie</td><td>${emp.sortie || '-'}</td></tr>
    <tr><td>Sanction</td><td>${emp.sanction || '-'}</td></tr>
    <tr><td>Date retrait</td><td>${emp.retrait || '-'}</td></tr>
  `;
  
  modal.classList.add('active');
}

function toggleGradeOptions(event) {
  event.stopPropagation();
  const options = event.target.nextElementSibling;
  options.classList.toggle('active');
}

function toggleStatusOptions(event) {
  event.stopPropagation();
  const options = event.target.nextElementSibling;
  options.classList.toggle('active');
}

async function updateGrade(empId, newGrade) {
  console.log('üîµ updateGrade appel√©:', { empId, newGrade, userGrade: currentUser.grade });
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
  const proxy = "https://corsproxy.io/?";
  
  const emp = allEmployees.find(e => e.id === empId);
  const oldGrade = emp ? emp.grade : 'Inconnu';
  const empName = emp ? emp.nom : 'Inconnu';
  
  if (!canAssignGrade(currentUser.grade, newGrade)) {
    showToast('‚ùå Vous ne pouvez pas assigner ce grade', 'error');
    return;
  }
  
  showToast('‚è≥ Mise √† jour...', 'info');
  
  try {
    await fetch(proxy + encodeURIComponent(url), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: empId, grade: newGrade })
    });
    
    if (emp) {
      emp.grade = newGrade;
      const filtered = filteredEmployees.find(e => e.id === empId);
      if (filtered) filtered.grade = newGrade;
    }
    
    showToast('‚úÖ Grade mis √† jour !', 'success');
    logAction(`Modification grade employ√© ID ${empId} (${empName}) : ${oldGrade} ‚Üí ${newGrade}`);
    closeModal();
    setTimeout(() => loadEmployees(), 1000);
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    showToast('‚ùå Erreur', 'error');
  }
}

function closeModal() {
  document.getElementById('employeeModal').classList.remove('active');
}

// ==================== RECRUITS ====================
async function loadRecruits() {
  const list = document.getElementById('recruitList');
  
  try {
    list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
    
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RECRUITMENT)}?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.values) {
      list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
      return;
    }

    const rows = data.values;
    let headerIndex = 0;
    
    const dataRows = rows.slice(headerIndex + 1);
    const unique = new Set();

    allRecruits = dataRows
      .map(r => ({
        gmail: r[0] ? r[0].toString().trim() : '',  // Colonne A
        id: r[4] ? r[4].toString().trim() : '',
        nom: r[5] ? r[5].toString().trim() : '',
        rib: r[6] ? r[6].toString().trim() : '',
        tel: r[8] ? r[8].toString().trim() : '',
        discord: r[9] ? r[9].toString().trim() : '',
        permis: r[10] ? r[10].toString().trim() : '',
        diplome: r[12] ? r[12].toString().trim() : '',
        carteId: r[14] ? r[14].toString().trim() : '',
        motivations: r[15] ? r[15].toString().trim() : '',
        qualites: r[16] ? r[16].toString().trim() : '',
        dispo: [
          {jour: 'Lun', heures: r[17] ? r[17].toString().trim() : ''},
          {jour: 'Mar', heures: r[18] ? r[18].toString().trim() : ''},
          {jour: 'Mer', heures: r[19] ? r[19].toString().trim() : ''},
          {jour: 'Jeu', heures: r[20] ? r[20].toString().trim() : ''},
          {jour: 'Ven', heures: r[21] ? r[21].toString().trim() : ''},
          {jour: 'Sam', heures: r[22] ? r[22].toString().trim() : ''},
          {jour: 'Dim', heures: r[23] ? r[23].toString().trim() : ''}
        ],
        pourquoi: r[24] ? r[24].toString().trim() : '',
        illegal: r[25] ? r[25].toString().trim() : '',
        mecano: r[26] ? r[26].toString().trim() : '',
        statut: r[27] ? r[27].toString().trim() : 'En attente',
        commentaires: r[28] ? r[28].toString().trim() : ''  // Colonne AC
      }))
      .filter(c => {
        if (!c.nom || unique.has(c.nom)) return false;
        unique.add(c.nom);
        return true;
      })
      .reverse();

    filteredRecruits = [...allRecruits];
    displayRecruits(filteredRecruits);

  } catch (error) {
    list.innerHTML = `<div class="info-message">‚ùå Erreur: ${error.message}</div>`;
  }
}

function displayRecruits(recruits) {
  const list = document.getElementById('recruitList');
  list.innerHTML = '';

  if (recruits.length === 0) {
    list.innerHTML = '<div class="info-message">Aucun candidat trouv√©</div>';
    return;
  }

  recruits.forEach(rec => {
    const card = document.createElement('div');
    card.className = 'employee-card';
    
    // Syst√®me de couleurs pour les recrutements
    const statusClass = getRecruitStatusClass(rec.statut);
    if (statusClass) {
      card.classList.add(statusClass);
    }
    
    card.innerHTML = `
      <div style="position:relative;">
        <div class="employee-name">${rec.nom}</div>
        <div class="employee-grade">${rec.statut}</div>
        ${rec.commentaires ? `
          <div class="comment-badge" onmouseenter="showCommentTooltip(event, this)" onmouseleave="hideCommentTooltip(this)">
            <img src="https://i.postimg.cc/Z0t9DHTr/Plan-de-travail-2Logo-Paleto-Garage.png" alt="Commentaire" style="width: 24px; height: 24px;">
            <div class="tooltip">${rec.commentaires.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          </div>
        ` : ''}
      </div>
    `;
    
    card.addEventListener('click', () => showRecruitDetails(rec));
    
    // Clic droit pour menu contextuel
    card.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showContextMenu(e, rec);
    });
    
    list.appendChild(card);
  });
}

// ==================== SEARCH ====================
document.addEventListener('DOMContentLoaded', () => {
  const searchBar = document.getElementById('searchBar');
  if (searchBar) {
    searchBar.addEventListener('input', (e) => {
      filterEmployeesByType();
    });
  }
  
  const searchBarRecruit = document.getElementById('searchBarRecruit');
  if (searchBarRecruit) {
    searchBarRecruit.addEventListener('input', (e) => {
      filterRecruitsByStatus();
    });
  }
});

// ==================== TOAST ====================
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ App d√©marrage...');
  
  const params = new URLSearchParams(window.location.search);
  const authStatus = params.get('auth');
  const error = params.get('error');
  
  if (authStatus === 'success') {
    checkAuth();
    window.history.replaceState({}, document.title, window.location.pathname);
  } else if (error) {
    const errors = {
      'no_code': 'Code d\'autorisation manquant',
      'not_employee': 'Votre ID Discord n\'est pas dans la liste des employ√©s',
      'auth_failed': '√âchec de l\'authentification',
      'session_error': 'Erreur de cr√©ation de session'
    };
    showToast(`‚ùå ${errors[error] || 'Erreur inconnue'}`, 'error');
    showLogin();
  } else {
    checkAuth();
  }
});

// Close modal on outside click
document.getElementById('employeeModal').addEventListener('click', (e) => {
  if (e.target.id === 'employeeModal') {
    closeModal();
  }
});


// ==================== COMMUNICATION IFRAME ====================
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? '' : 'light';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const icon = document.querySelector('.theme-icon');
  icon.textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  
  // Envoyer √† l'iframe
  sendThemeToIframe(newTheme);
}

function sendThemeToIframe(theme) {
  const iframe = document.querySelector('#tab-factures iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage({ 
      type: 'theme-change', 
      theme: theme 
    }, '*');
  }
}

// √âcouter les demandes de l'iframe
window.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'get-theme') {
    const currentTheme = document.documentElement.getAttribute('data-theme') || '';
    sendThemeToIframe(currentTheme);
  }
});

// Envoyer le theme quand l'iframe charge
document.addEventListener('DOMContentLoaded', () => {
  const iframe = document.querySelector('#tab-factures iframe');
  if (iframe) {
    iframe.addEventListener('load', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme') || '';
      sendThemeToIframe(currentTheme);
    });
  }
});


// ==================== SYST√àME DE PERMISSIONS ====================
const PERMISSIONS = {
  "Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
  "Co Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
  "DRH": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "banque", "logs"],
  "Responsable D'atelier": ["profil", "accueil", "employes", "absence", "factures", "partenariats", "banque", "logs"],
  "Responsable Evenementiel": ["profil", "accueil", "factures", "banque"],
  "Asst Evenemtiel": ["profil", "accueil", "factures", "banque"],
  "Chef d'atelier": ["profil", "accueil", "employes", "absence", "factures", "logs"],
  "RH": ["profil", "accueil", "employes", "recrutement", "absence"],
  "Confirm√©": ["profil", "accueil"],
  "M√©cano": ["profil", "accueil"],
  "Apprenti": ["profil", "accueil"],
  "Stagiaire": ["profil", "accueil"]
};

const CATEGORY_ICONS = {
  "profil": "üë§",
  "accueil": "üè†",
  "employes": "üë•",
  "recrutement": "üìã",
  "absence": "üìÖ",
  "factures": "üí∞",
  "partenariats": "ü§ù",
  "banque": "üè¶",
  "compta": "üìä",
  "logs": "üìú"
};

const CATEGORY_LABELS = {
  "profil": "Profil",
  "accueil": "Accueil",
  "employes": "Employ√©s",
  "recrutement": "Recrutement",
  "absence": "Absences",
  "factures": "Factures",
  "partenariats": "Partenariats",
  "banque": "Banque",
  "compta": "Compta",
  "logs": "Logs"
};

let userCategories = [];

function getUserCategories(grade) {
  return PERMISSIONS[grade] || ["profil", "accueil"];
}

function buildNavigation() {
  if (!currentUser || !currentUser.grade) {
    console.log('‚ùå Pas de grade utilisateur');
    userCategories = ["profil", "accueil"];
  } else {
    userCategories = getUserCategories(currentUser.grade);
  }
  
  console.log('‚úÖ Grade:', currentUser?.grade);
  console.log('‚úÖ Cat√©gories:', userCategories);
  
  const nav = document.getElementById('mainNavigation');
  if (!nav) return;
  
  nav.innerHTML = userCategories.map((cat, index) => {
    const label = CATEGORY_LABELS[cat] || cat;
    const activeClass = index === 0 ? 'active' : '';
    return `<button class="header-nav-item ${activeClass}" onclick="switchTab('${cat}')">${label}</button>`;
  }).join('');
  
  if (userCategories.length > 0) {
    switchTab(userCategories[0]);
  }
}

function loadProfilPage() {
  if (!currentUser) return;
  
  const profilContent = document.getElementById('profilContent');
  if (!profilContent) return;
  
  profilContent.innerHTML = `
    <h2>üë§ Mon Profil</h2>
    <div style="margin-top: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
      <div style="text-align: center; margin-bottom: 2rem;">
        <img src="${currentUser.avatar}" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-highlight);">
      </div>
      
      <table class="details-table">
        <tr><td><strong>Nom</strong></td><td>${currentUser.employeeName || currentUser.username}</td></tr>
        <tr><td><strong>Grade</strong></td><td>${currentUser.grade || 'Non d√©fini'}</td></tr>
        <tr><td><strong>Discord</strong></td><td>${currentUser.username}#${currentUser.discriminator}</td></tr>
        <tr><td><strong>ID Discord</strong></td><td>${currentUser.id}</td></tr>
        <tr><td><strong>R√¥le syst√®me</strong></td><td>${currentUser.role}</td></tr>
        <tr><td><strong>Cat√©gories accessibles</strong></td><td>${userCategories.length}</td></tr>
      </table>
      
      <div style="margin-top: 2rem; text-align: center;">
        <button class="logout-btn" onclick="logout()" style="display: inline-block;">
          üö™ D√©connexion
        </button>
      </div>
    </div>
  `;
}

function loadLogsPage() { loadLogs(); }


const P = {
  "Patron": ["profil","accueil","employes","recrutement","absence","factures"],
  "DRH": ["profil","accueil","employes","recrutement","absence","factures"],
  "RH": ["profil","accueil","employes","recrutement"],
  "Confirm√©": ["profil","accueil"]
};
const I = {"profil":"üë§","accueil":"üè†","employes":"üë•","recrutement":"üìã","absence":"üìÖ","factures":"üí∞"};
const L = {"profil":"Profil","accueil":"Accueil","employes":"Employ√©s","recrutement":"Recrutement","absence":"Absences","factures":"Factures"};



async function logAction(action) {
  console.log('üîµ logAction appel√©:', action);
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
  const proxy = "https://corsproxy.io/?";
  const now = new Date();
  const dateTime = now.toLocaleString('fr-FR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  
  try {
    await fetch(proxy + encodeURIComponent(url), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'log', prenomNom: currentUser?.employeeName || 'Inconnu', dateHeure: dateTime, action: action })
    });
    console.log('‚úÖ Requ√™te logAction envoy√©e:', { action, dateTime });
  } catch (error) {
    console.error('‚ùå Erreur log:', error);
  }
}

function showRecruitDetails(rec) {
  const modal = document.getElementById('employeeModal');
  const modalContent = document.getElementById('modalContent');
  
  const jours = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
  const dispoHTML = (rec.dispo && Array.isArray(rec.dispo)) ? rec.dispo.map((d, i) => 
    `<span style="display:inline-block;padding:0.3rem 0.6rem;margin:0.2rem;background:${d==='Oui'?'rgba(76,175,80,0.3)':'rgba(255,59,48,0.3)'};border-radius:6px;font-size:0.85rem;">${jours[i]}: ${d}</span>`
  ).join('') : 'Non renseign√©';
  
    modalContent.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:1.5rem;">
      
      <!-- Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:1rem;border-bottom:2px solid var(--color-border);">
        <h2 style="margin:0;font-size:1.8rem;">üìã ${rec.nom}</h2>
        <div class="status-selector">
          <button onclick="toggleStatusOptions(event)">${rec.statut === 'Accept√©' ? '‚úÖ' : rec.statut === 'Refus√©' ? '‚ùå' : rec.statut === 'Blacklist' ? 'üö´' : 'üïê'} ${rec.statut}</button>
          <div class="status-options">
            <div class="status-option" onclick="updateRecruitStatus('${rec.id}', 'En attente')">üïê En attente</div>
            <div class="status-option" onclick="updateRecruitStatus('${rec.id}', 'Accept√©')">‚úÖ Accept√©</div>
            <div class="status-option" onclick="updateRecruitStatus('${rec.id}', 'Refus√©')">‚ùå Refus√©</div>
            <div class="status-option" onclick="updateRecruitStatus('${rec.id}', 'Blacklist')">üö´ Blacklist</div>
          </div>
        </div>
      </div>
      
      <!-- Infos grid -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;">
        
        <div style="background:rgba(255,255,255,0.03);padding:1rem;border-radius:12px;border:1px solid var(--color-border);">
          <h3 style="margin:0 0 0.8rem 0;font-size:0.85rem;color:var(--color-text-dim);text-transform:uppercase;letter-spacing:1px;">üìû CONTACT</h3>
          <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.9rem;">
            <div><span style="color:var(--color-text-dim);">Tel:</span> <strong>${rec.tel || '-'}</strong></div>
            <div><span style="color:var(--color-text-dim);">Discord:</span> <strong>${rec.discord || '-'}</strong></div>
            <div><span style="color:var(--color-text-dim);">Gmail:</span> <strong>${rec.gmail || '-'}</strong></div>
            <div><span style="color:var(--color-text-dim);">ID:</span> <strong style="font-family:monospace;">${rec.id || '-'}</strong></div>
          </div>
        </div>
        
        <div style="background:rgba(255,255,255,0.03);padding:1rem;border-radius:12px;border:1px solid var(--color-border);">
          <h3 style="margin:0 0 0.8rem 0;font-size:0.85rem;color:var(--color-text-dim);text-transform:uppercase;letter-spacing:1px;">üìÑ INFORMATIONS</h3>
          <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.9rem;">
            <div>
              <span style="color:var(--color-text-dim);">Permis:</span> 
              ${rec.permis && (rec.permis.startsWith('http://') || rec.permis.startsWith('https://')) 
                ? `<a href="${rec.permis}" target="_blank" style="display:inline-block;margin-left:0.5rem;padding:0.3rem 0.8rem;background:rgba(233,69,96,0.2);color:var(--color-highlight);border:1px solid var(--color-highlight);border-radius:6px;text-decoration:none;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='rgba(233,69,96,0.3)'" onmouseout="this.style.background='rgba(233,69,96,0.2)'">üìÑ Voir le permis</a>`
                : `<strong>${rec.permis || '-'}</strong>`
              }
            </div>
            <div>
              <span style="color:var(--color-text-dim);">Dipl√¥me:</span> 
              ${rec.diplome && (rec.diplome.startsWith('http://') || rec.diplome.startsWith('https://')) 
                ? `<a href="${rec.diplome}" target="_blank" style="display:inline-block;margin-left:0.5rem;padding:0.3rem 0.8rem;background:rgba(233,69,96,0.2);color:var(--color-highlight);border:1px solid var(--color-highlight);border-radius:6px;text-decoration:none;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='rgba(233,69,96,0.3)'" onmouseout="this.style.background='rgba(233,69,96,0.2)'">üìÑ Voir le dipl√¥me</a>`
                : `<strong>${rec.diplome || '-'}</strong>`
              }
            </div>
            <div><span style="color:var(--color-text-dim);">RIB:</span> <strong style="font-family:monospace;font-size:0.85rem;">${rec.rib || '-'}</strong></div>
          </div>
        </div>
        
      </div>
      
      <!-- Disponibilit√©s -->
      <div style="background:rgba(255,255,255,0.03);padding:1.2rem;border-radius:12px;border:1px solid var(--color-border);">
        <h3 style="margin:0 0 1rem 0;font-size:0.85rem;color:var(--color-text-dim);text-transform:uppercase;letter-spacing:1px;">üìÖ DISPONIBILIT√âS</h3>
        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">${(rec.dispo && Array.isArray(rec.dispo)) ? rec.dispo.map((d) => {
          const disponible = d.heures && d.heures.length > 0;
          return `<span 
            style="display:inline-block;padding:0.4rem 0.8rem;background:${disponible?'rgba(76,175,80,0.2)':'rgba(255,59,48,0.2)'};border:1px solid ${disponible?'#4CAF50':'#FF3B30'};border-radius:8px;font-size:0.85rem;font-weight:500;cursor:${disponible?'help':'default'};position:relative;"
            title="${disponible ? d.heures : 'Indisponible'}"
            onmouseover="this.querySelector('.tooltip').style.display='block'"
            onmouseout="this.querySelector('.tooltip').style.display='none'">
            ${d.jour}
            ${disponible ? `<div class="tooltip" style="display:none;position:absolute;top:-35px;left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;padding:0.4rem 0.8rem;border-radius:6px;white-space:nowrap;font-size:0.75rem;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.3);">${d.heures}</div>` : ''}
          </span>`;
        }).join('') : '<p style="color:var(--color-text-dim);">Non renseign√©</p>'}</div>
      </div>
      
      <!-- Sections questions -->
      <div style="background:rgba(233,69,96,0.05);padding:1.2rem;border-radius:12px;border-left:4px solid var(--color-highlight);">
        <h3 style="margin:0 0 0.8rem 0;font-size:0.95rem;color:var(--color-highlight);">üí≠ Motivations</h3>
        <p style="margin:0;line-height:1.6;color:var(--color-text);">${rec.motivations || '<span style="color:var(--color-text-dim);font-style:italic;">Non renseign√©</span>'}</p>
      </div>
      
      <div style="background:rgba(233,69,96,0.05);padding:1.2rem;border-radius:12px;border-left:4px solid var(--color-highlight);">
        <h3 style="margin:0 0 0.8rem 0;font-size:0.95rem;color:var(--color-highlight);">‚ú® Qualit√©s / D√©fauts</h3>
        <p style="margin:0;line-height:1.6;color:var(--color-text);">${rec.qualites || '<span style="color:var(--color-text-dim);font-style:italic;">Non renseign√©</span>'}</p>
      </div>
      
      <div style="background:rgba(233,69,96,0.05);padding:1.2rem;border-radius:12px;border-left:4px solid var(--color-highlight);">
        <h3 style="margin:0 0 0.8rem 0;font-size:0.95rem;color:var(--color-highlight);">‚ùì Pourquoi vous et pas un autre ?</h3>
        <p style="margin:0;line-height:1.6;color:var(--color-text);">${rec.pourquoi || '<span style="color:var(--color-text-dim);font-style:italic;">Non renseign√©</span>'}</p>
      </div>
      
      <div style="background:rgba(233,69,96,0.05);padding:1.2rem;border-radius:12px;border-left:4px solid var(--color-highlight);">
        <h3 style="margin:0 0 0.8rem 0;font-size:0.95rem;color:var(--color-highlight);">üîß C'est quoi un m√©cano pour vous ?</h3>
        <p style="margin:0;line-height:1.6;color:var(--color-text);">${rec.mecano || '<span style="color:var(--color-text-dim);font-style:italic;">Non renseign√©</span>'}</p>
      </div>
      
    </div>
  `;
  
  // Ajouter section commentaires
  const commentsSection = document.createElement('div');
  commentsSection.style.cssText = 'margin-top:2rem;padding-top:2rem;border-top:2px solid var(--color-border);';
  
  commentsSection.innerHTML = `
    <h3 style="margin:0 0 1rem 0;font-size:1.2rem;color:var(--color-highlight);">üí¨ Commentaire interne</h3>
    
    <div style="position:relative;">
      <!-- Zone de commentaire √©ditable -->
      <div 
        id="commentDisplay"
        ondblclick="editComment('${rec.id}')"
        style="padding:1rem;background:rgba(0,0,0,0.2);border:2px dashed var(--color-border);border-radius:8px;min-height:80px;cursor:pointer;transition:all 0.2s;color:${rec.commentaires ? 'var(--color-text)' : 'var(--color-text-dim)'};font-style:${rec.commentaires ? 'normal' : 'italic'};"
        onmouseover="this.style.borderColor='var(--color-highlight)'"
        onmouseout="this.style.borderColor='var(--color-border)'"
      >${rec.commentaires || 'Double-cliquez pour ajouter un commentaire...'}</div>
      
      <!-- Zone d'√©dition (cach√©e par d√©faut) -->
      <div id="commentEdit" style="display:none;">
        <textarea 
          id="commentTextarea"
          style="width:100%;padding:1rem;background:rgba(255,255,255,0.05);border:2px solid var(--color-highlight);border-radius:8px;color:var(--color-text);font-family:inherit;resize:vertical;min-height:80px;box-sizing:border-box;"
          placeholder="√âcrire un commentaire interne..."
        >${rec.commentaires || ''}</textarea>
        <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
          <button 
            onclick="saveComment('${rec.id}')"
            style="padding:0.5rem 1.5rem;background:var(--color-highlight);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;"
            onmouseover="this.style.background='#ff6b8a'"
            onmouseout="this.style.background='var(--color-highlight)'"
          >
            ‚úì Enregistrer
          </button>
          <button 
            onclick="cancelEditComment()"
            style="padding:0.5rem 1.5rem;background:rgba(255,255,255,0.1);color:var(--color-text);border:1px solid var(--color-border);border-radius:8px;cursor:pointer;transition:all 0.2s;"
            onmouseover="this.style.background='rgba(255,255,255,0.15)'"
            onmouseout="this.style.background='rgba(255,255,255,0.1)'"
          >
            ‚úï Annuler
          </button>
        </div>
      </div>
    </div>
  `;
  
  modalContent.appendChild(commentsSection);
  
  modal.classList.add('active');
}



async function updateRecruitStatus(recruitId, newStatus) {
  console.log('üîµ updateRecruitStatus appel√©:', { recruitId, newStatus });
  
  // Fermer le menu de statut imm√©diatement
  const statusOptions = document.querySelector('.status-options');
  if (statusOptions) {
    statusOptions.classList.remove('show');
  }
  
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
  const proxy = "https://corsproxy.io/?";
  
  showToast('‚è≥ Mise √† jour du statut...', 'info');
  
  try {
    console.log('üì§ Envoi requ√™te:', { type: 'updateRecruitStatus', id: recruitId, status: newStatus });
    
    const response = await fetch(proxy + encodeURIComponent(url), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        type: 'updateRecruitStatus',
        id: recruitId, 
        status: newStatus 
      })
    });
    
    console.log('üì• Response status:', response.status, response.statusText);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ R√©ponse compl√®te:', result);
    
    if (result.success === false) {
      throw new Error(result.error || 'Erreur serveur');
    }
    
    showToast(`‚úÖ Statut ‚Üí ${newStatus}`, 'success');
    
    // Trouver le nom du candidat
    const recruit = allRecruits.find(r => r.id === recruitId);
    const recruitName = recruit ? recruit.nom : 'Inconnu';
    logAction(`Modification statut candidat ${recruitName} (ID ${recruitId}) ‚Üí ${newStatus}`);
    
    // Fermer la modal et rafra√Æchir
    closeModal();
    
    // Attendre un peu plus longtemps pour √™tre s√ªr que Google Sheets est √† jour
    setTimeout(() => {
      console.log('üîÑ Rafra√Æchissement de la liste...');
      loadRecruits();
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Erreur compl√®te:', error);
    console.error('‚ùå Stack:', error.stack);
    showToast(`‚ùå Erreur: ${error.message}`, 'error');
  }
}


let currentRecruit = null;

function showContextMenu(event, recruit) {
  event.preventDefault();
  event.stopPropagation();
  
  console.log('üîµ showContextMenu appel√©:', recruit);
  
  const menu = document.getElementById('contextMenu');
  currentRecruit = recruit;
  
  console.log('‚úÖ currentRecruit d√©fini:', currentRecruit);
  
  // Positionner le menu (utiliser clientX/Y pour position fixed)
  menu.style.left = event.clientX + 'px';
  menu.style.top = event.clientY + 'px';
  menu.style.display = 'block';
  
  // Fermer si clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      // Ne pas fermer si on clique sur le menu lui-m√™me
      if (!menu.contains(e.target)) {
        menu.style.display = 'none';
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

async function addRecruitAsEmployee(grade) {
  console.log('üîµ addRecruitAsEmployee appel√©:', { grade, currentRecruit });
  
  if (!currentRecruit) {
    console.error('‚ùå currentRecruit est null/undefined !');
    showToast('‚ùå Erreur: Aucun candidat s√©lectionn√©', 'error');
    return;
  }
  
  const menu = document.getElementById('contextMenu');
  menu.style.display = 'none';
  
  console.log('üì§ Envoi requ√™te addRecruitAsEmployee:', { grade, recruit: currentRecruit });
  showToast('‚è≥ Ajout en cours...', 'info');
  
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
  const proxy = "https://corsproxy.io/?";
  
  const today = new Date().toLocaleDateString('fr-FR');
  
  try {
    const response = await fetch(proxy + encodeURIComponent(url), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'addRecruitAsEmployee',
        recruit: {
          id: currentRecruit.id,
          nom: currentRecruit.nom,
          rib: currentRecruit.rib,
          grade: grade,
          tel: currentRecruit.tel,
          discord: currentRecruit.discord,
          permis: currentRecruit.permis,
          gmail: currentRecruit.gmail || '',
          diplome: currentRecruit.diplome,
          dateEntree: today
        }
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ R√©ponse addRecruitAsEmployee:', result);
    
    if (result.success === false) {
      throw new Error(result.error || 'Erreur serveur');
    }
    
    showToast(`‚úÖ ${currentRecruit.nom} ajout√© comme ${grade} !`, 'success');
    logAction(`Ajout recrue ${currentRecruit.nom} (ID ${currentRecruit.id}) comme ${grade}`);
    
    // Rafra√Æchir les employ√©s
    setTimeout(() => loadEmployees(), 1000);
    
  } catch (error) {
    console.error('‚ùå Erreur addRecruitAsEmployee:', error);
    showToast(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

// Fonctions pour g√©rer le commentaire √©ditable
function editComment(recruitId) {
  document.getElementById('commentDisplay').style.display = 'none';
  document.getElementById('commentEdit').style.display = 'block';
  document.getElementById('commentTextarea').focus();
}

function cancelEditComment() {
  document.getElementById('commentDisplay').style.display = 'block';
  document.getElementById('commentEdit').style.display = 'none';
}

async function saveComment(recruitId) {
  const textarea = document.getElementById('commentTextarea');
  const commentText = textarea.value.trim();
  
  console.log('üîµ saveComment appel√©:', { recruitId, commentText });
  
  showToast('‚è≥ Enregistrement...', 'info');
  
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
  const proxy = "https://corsproxy.io/?";
  
  try {
    const response = await fetch(proxy + encodeURIComponent(url), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'updateRecruitComment',
        recruitId: recruitId,
        comment: commentText
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ R√©ponse saveComment:', result);
    
    if (result.success === false) {
      throw new Error(result.error || 'Erreur serveur');
    }
    
    showToast('‚úÖ Commentaire enregistr√© !', 'success');
    
    // Mettre √† jour l'affichage
    const display = document.getElementById('commentDisplay');
    display.textContent = commentText || 'Double-cliquez pour ajouter un commentaire...';
    display.style.color = commentText ? 'var(--color-text)' : 'var(--color-text-dim)';
    display.style.fontStyle = commentText ? 'normal' : 'italic';
    
    cancelEditComment();
    
    // Trouver le nom du candidat
    const recruit = allRecruits.find(r => r.id === recruitId);
    const recruitName = recruit ? recruit.nom : 'Inconnu';
    logAction(`Commentaire modifi√© pour candidat ${recruitName} (ID ${recruitId})`);
    
    // Rafra√Æchir les recrues
    setTimeout(() => loadRecruits(), 1000);
    
  } catch (error) {
    console.error('‚ùå Erreur saveComment:', error);
    showToast(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

// Fonctions pour g√©rer le tooltip de commentaire
function showCommentTooltip(event, badgeElement) {
  const tooltip = badgeElement.querySelector('.tooltip');
  if (!tooltip) return;
  
  // Positionner le tooltip en fixed par rapport √† la position de la souris
  const rect = badgeElement.getBoundingClientRect();
  
  // Position : en dessous √† droite de la bulle
  tooltip.style.top = (rect.bottom + 8) + 'px';
  tooltip.style.right = (window.innerWidth - rect.right) + 'px';
  tooltip.style.left = 'auto';
  
  // Si le tooltip d√©passe en bas, le mettre au-dessus
  setTimeout(() => {
    const tooltipRect = tooltip.getBoundingClientRect();
    if (tooltipRect.bottom > window.innerHeight - 10) {
      tooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
    }
  }, 10);
}

function hideCommentTooltip(badgeElement) {
  const tooltip = badgeElement.querySelector('.tooltip');
  if (tooltip) {
    tooltip.style.display = 'none';
    // R√©initialiser pour que le :hover CSS reprenne le contr√¥le
    setTimeout(() => {
      tooltip.style.display = '';
    }, 100);
  }
}

async function loadLogs() {
  const container = document.getElementById('logsContainer');
  if (!container) return;
  
  try {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${LOGS_SHEET_ID}/values/Logs!A:C?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    const now = new Date().toLocaleTimeString('fr-FR');
    
    if (!data.values || data.values.length <= 1) {
      container.innerHTML = '<p style="text-align:center;color:var(--color-text-dim);">Aucun log pour le moment.</p>';
      return;
    }
    
    const logs = data.values.slice(1).reverse();
    let html = '<div style="display:flex;justify-content:space-between;margin-bottom:1rem;"><h3 style="margin:0;">üìú Historique</h3><span style="color:var(--color-text-dim);font-size:0.9rem;">üîÑ ' + now + '</span></div>';
    html += '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:rgba(233,69,96,0.1);"><th style="padding:1rem;text-align:left;">Utilisateur</th><th style="padding:1rem;text-align:left;">Date & Heure</th><th style="padding:1rem;text-align:left;">Action</th></tr></thead><tbody>';
    logs.forEach((log, i) => {
      const bg = i % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'transparent';
      html += `<tr style="background:${bg};"><td style="padding:1rem;">${log[0]||'-'}</td><td style="padding:1rem;font-size:0.9rem;">${log[1]||'-'}</td><td style="padding:1rem;">${log[2]||'-'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('‚ùå Erreur logs:', error);
  }
}

</script>

  <!-- CONTEXT MENU -->
  <div id="contextMenu">
    <div class="context-menu-item" onclick="addRecruitAsEmployee('Apprenti')">
      <span>üéì</span>
      <span>Ajouter comme Apprenti</span>
    </div>
    <div class="context-menu-item" onclick="addRecruitAsEmployee('Stagiaire')">
      <span>üìù</span>
      <span>Ajouter comme Stagiaire</span>
    </div>
  </div>
</body>
</html>
