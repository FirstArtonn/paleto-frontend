<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paleto Garage - Gestion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --color-primary: #1a1a2e;
  --color-secondary: #16213e;
  --color-accent: #0f3460;
  --color-highlight: #e94560;
  --color-gold: #d4af37;
  --color-bg: #0a0a12;
  --color-surface: #1a1a2e;
  --color-text: #e8e8e8;
  --color-text-dim: #a0a0a8;
  --color-border: #2a2a3e;
}

[data-theme="light"] {
  --color-primary: #f8fafc;
  --color-secondary: #e2e8f0;
  --color-accent: #cbd5e1;
  --color-highlight: #6366f1;
  --color-gold: #8b5cf6;
  --color-bg: #ffffff;
  --color-surface: #f8fafc;
  --color-text: #0f172a;
  --color-text-dim: #64748b;
  --color-border: #e2e8f0;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Outfit', sans-serif;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
  color: var(--color-text);
  min-height: 100vh;
  transition: background 0.3s ease, color 0.3s ease;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(15, 52, 96, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* LOGIN PAGE */
.login-container {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
}

.login-card {
  background: rgba(26, 26, 46, 0.9);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 3rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  text-align: center;
  max-width: 450px;
  width: 90%;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.login-card h1 {
  font-family: Impact, sans-serif;
  font-size: 3rem;
  background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-highlight) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
}

.login-card p {
  color: var(--color-text-dim);
  margin-bottom: 2rem;
  font-size: 1.05rem;
}

.discord-login-btn {
  background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 8px 20px rgba(88, 101, 242, 0.4);
}

.discord-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(88, 101, 242, 0.6);
}

.discord-login-btn svg {
  width: 24px;
  height: 24px;
}

.login-info {
  margin-top: 2rem;
  padding: 1.5rem;
  background: rgba(233, 69, 96, 0.1);
  border-radius: 12px;
  border: 1px solid rgba(233, 69, 96, 0.2);
  color: var(--color-text-dim);
  font-size: 0.9rem;
  line-height: 1.6;
}

/* HEADER */
header {
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 2rem;
  margin: 2rem;
  position: relative;
  z-index: 100;
}

[data-theme="light"] header {
  background: rgba(255, 255, 255, 0.9);
}

header h1 {
  font-family: Impact, sans-serif;
  font-size: 3.5rem;
  background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-highlight) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
}

[data-theme="light"] header h1 {
  background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.subtitle {
  text-align: center;
  font-size: 1rem;
  color: var(--color-text-dim);
  font-weight: 400;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 2rem;
}

/* USER PROFILE */
.user-profile {
  position: absolute;
  top: 2rem;
  right: 8rem;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid var(--color-border);
  border-radius: 50px;
  transition: all 0.3s;
}

.user-profile:hover {
  background: rgba(255, 255, 255, 0.1);
}

.user-profile img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid var(--color-highlight);
}

.username {
  font-weight: 600;
  color: var(--color-text);
}

.logout-btn {
  background: rgba(233, 69, 96, 0.2);
  border: 1px solid var(--color-highlight);
  color: var(--color-highlight);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
  margin-left: 8px;
}

.logout-btn:hover {
  background: var(--color-highlight);
  color: white;
}

/* THEME TOGGLE */
.theme-toggle {
  position: absolute;
  top: 2rem;
  right: 2rem;
  width: 60px;
  height: 30px;
  background: var(--color-border);
  border-radius: 15px;
  cursor: pointer;
  transition: background 0.3s;
}

.theme-toggle:hover {
  background: var(--color-highlight);
}

.theme-slider {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

[data-theme="light"] .theme-slider {
  transform: translateX(30px);
}

.theme-icon {
  font-size: 14px;
}

/* NAVIGATION */
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: none !important;
  border: none !important;
  padding: 0 !important;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--color-text);
  cursor: pointer;
  padding: 8px 0;
  background: none !important;
  border: none !important;
  transition: color 0.3s ease;
  user-select: none;
}

.nav-item:hover {
  color: var(--color-highlight);
}

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: var(--color-highlight);
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after {
  width: 100%;
}

/* CONTENT CONTAINER */
.content-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}

/* TAB CONTENT */
.tab-content {
  display: none;
  animation: fadeIn 0.5s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* EMPLOYEE CARDS */
.search-container {
  margin: 2rem 0;
  text-align: center;
}

.search-input {
  width: 100%;
  max-width: 400px;
  padding: 1rem 1.5rem;
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  color: var(--color-text);
  font-size: 1rem;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: var(--color-highlight);
  box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
}

.search-input::placeholder {
  color: var(--color-text-dim);
}

.employee-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.employee-card {
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 16px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.employee-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--color-gold), var(--color-highlight));
  transform: scaleX(0);
  transition: transform 0.3s;
}

.employee-card:hover::before {
  transform: scaleX(1);
}

.employee-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(233, 69, 96, 0.3);
  border-color: var(--color-highlight);
}

.employee-card.sanction-1 {
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(26, 26, 46, 0.8));
  animation: pulse 2s infinite;
}

.employee-card.sanction-2 {
  background: linear-gradient(135deg, rgba(255, 140, 0, 0.2), rgba(26, 26, 46, 0.8));
  animation: pulse 2s infinite;
}

.employee-card.sanction-3 {
  background: linear-gradient(135deg, rgba(255, 51, 51, 0.2), rgba(26, 26, 46, 0.8));
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.employee-name {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 0.5rem;
}

.employee-grade {
  font-size: 0.95rem;
  color: var(--color-text-dim);
}

/* EMPLOYEE DETAILS MODAL */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 1000;
  padding: 2rem;
  overflow-y: auto;
}

.modal.active {
  display: flex;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s;
}

.modal-content {
  background: rgba(26, 26, 46, 0.95);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 2.5rem;
  max-width: 800px;
  width: 100%;
  position: relative;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}

.close-btn {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 36px;
  height: 36px;
  background: rgba(233, 69, 96, 0.2);
  border: 1px solid var(--color-highlight);
  border-radius: 50%;
  color: var(--color-highlight);
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.close-btn:hover {
  background: var(--color-highlight);
  color: white;
  transform: rotate(90deg);
}

.modal-content h2 {
  font-size: 2rem;
  margin-bottom: 2rem;
  color: var(--color-text);
}

.details-table {
  width: 100%;
  border-collapse: collapse;
}

.details-table tr {
  border-bottom: 1px solid var(--color-border);
}

.details-table td {
  padding: 1rem;
  color: var(--color-text);
}

.details-table td:first-child {
  font-weight: 600;
  color: var(--color-text-dim);
  width: 200px;
}

/* DIPLOME BUTTONS */
.diplome-btn {
  background: rgba(212, 175, 55, 0.2);
  border: 1px solid var(--color-gold);
  color: var(--color-gold);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
  margin: 0.25rem;
  display: inline-block;
}

.diplome-btn:hover {
  background: var(--color-gold);
  color: var(--color-bg);
}

/* GRADE SELECTOR */
.grade-selector {
  position: relative;
  display: inline-block;
  width: 100%;
}

.grade-selector button {
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  color: var(--color-text);
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
}

.grade-selector button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--color-highlight);
}

.grade-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(26, 26, 46, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  margin-top: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  display: none;
  z-index: 10;
}

.grade-options.active {
  display: block;
}

.grade-option {
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--color-text);
}

.grade-option:hover {
  background: rgba(233, 69, 96, 0.2);
  color: var(--color-highlight);
}

/* TOAST */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  padding: 1rem 1.5rem;
  background: rgba(26, 26, 46, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  color: var(--color-text);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  z-index: 10000;
  animation: slideInRight 0.3s;
  display: none;
}

.toast.show {
  display: block;
}

.toast.success {
  border-color: #4ade80;
  background: rgba(74, 222, 128, 0.1);
}

.toast.error {
  border-color: var(--color-highlight);
  background: rgba(233, 69, 96, 0.1);
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* IFRAME CONTAINER */
.iframe-container {
  width: 100%;
  height: calc(100vh - 250px);
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 16px;
  overflow: hidden;
}

.iframe-container iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* INFO MESSAGE */
.info-message {
  text-align: center;
  padding: 3rem;
  color: var(--color-text-dim);
  font-size: 1.1rem;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  header h1 {
    font-size: 2.5rem;
  }

  .user-profile {
    position: static;
    margin: 1rem auto 0;
    width: fit-content;
  }

  .employee-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
    padding: 1.5rem;
  }
}

#tab-factures .content-container,
#tab-factures.content-container {
  padding: 0;
  max-width: 100%;
}

#tab-factures {
  padding: 0 !important;
  margin: 0 !important;
}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-container" id="loginContainer">
  <div class="login-card">
    <h1>PALETO GARAGE</h1>
    <p>Connectez-vous avec Discord pour acc√©der au syst√®me de gestion</p>
    
    <button class="discord-login-btn" onclick="loginWithDiscord()">
      <svg viewBox="0 0 127.14 96.36" fill="currentColor">
        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
      </svg>
      Se connecter avec Discord
    </button>

    <div class="login-info">
      <strong>‚ÑπÔ∏è Information</strong><br>
      Votre ID Discord doit √™tre dans la liste des employ√©s pour acc√©der √† cette application.
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
  <header>
    <div class="user-profile" id="userProfile">
      <img id="userAvatar" src="" alt="Avatar">
      <span class="username" id="userName"></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>

    <div class="theme-toggle" onclick="toggleTheme()" title="Changer de th√®me">
      <div class="theme-slider">
        <span class="theme-icon">üåô</span>
      </div>
    </div>

    <h1>PALETO GARAGE</h1>
    <div class="subtitle">Syst√®me de Gestion - By Artonn</div>

    <nav class="navigation" id="mainNavigation">
      <!-- Navigation g√©n√©r√©e dynamiquement -->
    </nav>
  </header>

  <div class="content-container">
    <!-- ACCUEIL -->
    <div class="tab-content active" id="tab-accueil">
      <div class="info-message">
        <h2>üëã Bienvenue <span id="welcomeName"></span></h2>
        <p style="margin-top: 1rem;">Utilisez le menu ci-dessus pour naviguer entre les diff√©rentes sections.</p>
        <div style="margin-top: 2rem; padding: 2rem; background: rgba(233, 69, 96, 0.1); border-radius: 16px; border: 1px solid var(--color-highlight);">
          <strong>Vos permissions :</strong>
          <p id="userPermissions" style="margin-top: 1rem;"></p>
        </div>
      </div>
    </div>

    <!-- EMPLOY√âS -->
    <div class="tab-content" id="tab-employes">
      <div class="search-container">
        <input type="text" class="search-input" id="searchBar" placeholder="üîç Rechercher un employ√©...">
      </div>
      <div class="employee-grid" id="employeeList"></div>
    </div>

    <!-- RECRUTEMENT -->
    <div class="tab-content" id="tab-recrutement">
      <div class="search-container">
        <input type="text" class="search-input" id="searchBarRecruit" placeholder="üîç Rechercher un candidat...">
      </div>
      <div class="employee-grid" id="recruitList"></div>
    </div>

    <!-- FACTURES -->
    <div class="tab-content" id="tab-factures">
      <div class="iframe-container">
        <iframe src="Facture_Paleto.html"></iframe>
      </div>
    </div>

    <!-- ABSENCE -->
    <div class="tab-content" id="tab-absence">
      <div class="info-message">
        <h2>üìÖ Gestion des absences</h2>
        <p style="margin-top: 1rem;">Cette section est en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- PROFIL -->
    <div class="tab-content" id="tab-profil">
      <div class="info-message" id="profilContent">
        <h2>üë§ Mon Profil</h2>
        <p style="margin-top: 1rem;">Chargement...</p>
      </div>
    </div>

    <!-- PARTENARIATS -->
    <div class="tab-content" id="tab-partenariats">
      <div class="info-message">
        <h2>ü§ù Partenariats</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- BANQUE -->
    <div class="tab-content" id="tab-banque">
      <div class="info-message">
        <h2>üè¶ Banque</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- COMPTA -->
    <div class="tab-content" id="tab-compta">
      <div class="info-message">
        <h2>üìä Comptabilit√©</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- LOGS -->
    <div class="tab-content" id="tab-logs">
      <div class="info-message">
        <h2>üìú Historique</h2>
        <div id="logsContainer" style="margin-top: 2rem;">
          <p>Chargement des logs...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EMPLOYEE DETAILS MODAL -->
<div class="modal" id="employeeModal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">‚úñ</div>
    <h2 id="modalTitle"></h2>
    <table class="details-table" id="modalContent"></table>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ==================== CONFIG ====================
const BACKEND_URL = "https://paleto-backend.vercel.app";
const SHEET_ID = "17ZntDHZ8olidnCM1pig311AcjawM4l6HoRxSYFP7KGw";
const API_KEY = "AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E";
const SHEET_EMPLOYEES = "Info Employ√©";
const SHEET_RECRUITMENT = "Formulaire Info
<function_calls>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">paleto_garage_html_final</parameter>
<parameter name="old_str">const SHEET_RECRUITMENT = "Formulaire Info</parameter>
<parameter name="new_str">const SHEET_RECRUITMENT = "Formulaire Info ";
// ==================== CONFIG LOGS ====================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzq78RDmGl-x5fgbGHUS-GGkBRJf0s3pBpHt21HYjjOtXLB1ezYy_epFNx8gmRfw6s/exec';
const LOGS_SHEET_ID = "19YnTEHpGQSoqMbInvK29HWsPBXzoexYcqzRVDJjKsyI";
const LOGS_API_KEY = "AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E";
const GRADES = [
"Patron", "Co Patron", "DRH", "RH", "Responsable D'atelier",
"Chef d'atelier", "Confirm√©", "M√©cano", "Apprenti", "Stagiaire"
];
let currentUser = null;
let allEmployees = [];
let filteredEmployees = [];
let allRecruits = [];
let filteredRecruits = [];
// ==================== AUTH ====================
function loginWithDiscord() {
console.log('üîó Connexion Discord...');
window.location.href = ${BACKEND_URL}/auth/discord;
}
async function checkAuth() {
try {
console.log('üîç V√©rification auth...');
const response = await fetch(${BACKEND_URL}/api/check-auth, {
credentials: 'include'
});
const data = await response.json();
console.log('üì• R√©ponse:', data);

if (data.authenticated) {
  currentUser = data.user;
  showApp();
} else {
  showLogin();
}
} catch (error) {
console.error('‚ùå Erreur auth:', error);
showLogin();
}
}
async function logout() {
try {
await addLog('D√©connexion de l'application');
setTimeout(async () => {
await fetch(${BACKEND_URL}/api/logout, {
method: 'POST',
credentials: 'include'
});
currentUser = null;
showLogin();
showToast('üëã D√©connexion r√©ussie', 'success');
}, 500);
} catch (error) {
console.error('‚ùå Erreur logout:', error);
}
}
function showLogin() {
document.getElementById('loginContainer').style.display = 'flex';
document.getElementById('mainApp').style.display = 'none';
}
function showApp() {
document.getElementById('loginContainer').style.display = 'none';
document.getElementById('mainApp').style.display = 'block';
document.getElementById('userAvatar').src = currentUser.avatar;
document.getElementById('userName').textContent = currentUser.employeeName || currentUser.username;
document.getElementById('welcomeName').textContent = currentUser.employeeName || currentUser.username;
const permissions = {
'admin': 'Administrateur - Acc√®s complet',
'rh': 'Ressources Humaines - Acc√®s aux employ√©s et recrutement',
'employee': 'Employ√© - Consultation uniquement',
'visitor': 'Visiteur - Acc√®s limit√©'
};
document.getElementById('userPermissions').textContent = permissions[currentUser.role];
document.body.className = role-${currentUser.role};
buildNavigation();
loadProfilPage();
loadEmployees();
loadRecruits();
setTimeout(() => addLog('Connexion √† l'application'), 1000);
}
// ==================== NAVIGATION ====================
function switchTab(tabName) {
document.querySelectorAll('.nav-item').forEach(item => {
item.classList.remove('active');
});
document.querySelectorAll('.nav-item').forEach(item => {
const onclick = item.getAttribute('onclick');
if (onclick && onclick.includes("'" + tabName + "'")) {
item.classList.add('active');
}
});
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
const targetTab = document.getElementById('tab-' + tabName);
if (targetTab) {
targetTab.classList.add('active');
}
const label = CATEGORY_LABELS[tabName] || tabName;
addLog(Navigation vers l'onglet "${label}");
if (tabName === 'logs') {
loadLogsPage();
}
}
// ==================== THEME ====================
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
document.documentElement.setAttribute('data-theme', savedTheme);
document.querySelector('.theme-icon').textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
}
function toggleTheme() {
const html = document.documentElement;
const currentTheme = html.getAttribute('data-theme');
const newTheme = currentTheme === 'light' ? '' : 'light';
html.setAttribute('data-theme', newTheme);
localStorage.setItem('theme', newTheme);
const icon = document.querySelector('.theme-icon');
icon.textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
sendThemeToIframe(newTheme);
const themeName = newTheme === 'light' ? 'clair' : 'sombre';
addLog(Changement de th√®me ‚Üí mode ${themeName});
}
function sendThemeToIframe(theme) {
const iframe = document.querySelector('#tab-factures iframe');
if (iframe && iframe.contentWindow) {
iframe.contentWindow.postMessage({
type: 'theme-change',
theme: theme
}, '*');
}
}
window.addEventListener('message', (event) => {
if (event.data && event.data.type === 'get-theme') {
const currentTheme = document.documentElement.getAttribute('data-theme') || '';
sendThemeToIframe(currentTheme);
}
});
// ==================== EMPLOYEES ====================
async function loadEmployees() {
const list = document.getElementById('employeeList');
try {
list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_EMPLOYEES)}?key=${API_KEY}`;
const response = await fetch(url);
const data = await response.json();

if (!data.values) {
  list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
  return;
}

const rows = data.values;
let headerIndex = -1;

for (let i = 0; i < rows.length; i++) {
  if (rows[i] && rows[i].some(cell => 
    cell && cell.toString().includes("Pr√©nom / Nom")
  )) {
    headerIndex = i;
    break;
  }
}

if (headerIndex === -1) {
  list.innerHTML = '<div class="info-message">‚ùå En-t√™te introuvable</div>';
  return;
}

const dataRows = rows.slice(headerIndex + 1);
const unique = new Set();

allEmployees = dataRows
  .filter(row => {
    const nom = row[2] ? row[2].toString().trim() : '';
    return nom && nom !== "Pr√©nom / Nom" && nom !== "D√©mission/Licenciement";
  })
  .map(r => ({
    id: r[1] ? r[1].toString().trim() : '',
    nom: r[2] ? r[2].toString().trim() : '',
    rib: r[3] ? r[3].toString().trim() : '',
    grade: r[4] ? r[4].toString().trim() : '',
    tel: r[5] ? r[5].toString().trim() : '',
    discord: r[6] ? r[6].toString().trim() : '',
    gmail: r[8] ? r[8].toString().trim() : '',
    diplome: r[9] ? r[9].toString().trim() : '',
    entree: r[10] ? r[10].toString().trim() : '',
    sortie: r[11] ? r[11].toString().trim() : '',
    sanction: r[12] ? r[12].toString().trim() : '',
    retrait: r[13] ? r[13].toString().trim() : ''
  }))
  .filter(e => {
    if (!e.nom || unique.has(e.nom)) return false;
    unique.add(e.nom);
    return true;
  });

filteredEmployees = [...allEmployees];
displayEmployees(filteredEmployees);
} catch (error) {
list.innerHTML = <div class="info-message">‚ùå Erreur: ${error.message}</div>;
}
}
function displayEmployees(employees) {
const list = document.getElementById('employeeList');
list.innerHTML = '';
if (employees.length === 0) {
list.innerHTML = '<div class="info-message">Aucun employ√© trouv√©</div>';
return;
}
employees.forEach((emp, index) => {
const card = document.createElement('div');
card.className = 'employee-card';
if (emp.sanction === 'Avertissement 1') card.classList.add('sanction-1');
if (emp.sanction === 'Avertissement 2') card.classList.add('sanction-2');
if (emp.sanction === 'Licenciement') card.classList.add('sanction-3');

card.innerHTML = `
  <div class="employee-name">${emp.nom}</div>
  <div class="employee-grade">${emp.grade || 'Sans grade'}</div>
`;

card.onclick = () => showEmployeeDetails(index);
list.appendChild(card);
});
}
function showEmployeeDetails(index) {
const emp = filteredEmployees[index];
const modal = document.getElementById('employeeModal');
const title = document.getElementById('modalTitle');
const content = document.getElementById('modalContent');
title.textContent = üë§ ${emp.nom};
let diplomeHTML = '<em>Aucun dipl√¥me</em>';
if (emp.diplome) {
const links = emp.diplome.split(/\s+/).filter(l => l.startsWith('http'));
if (links.length > 0) {
diplomeHTML = links.map((link, i) => {
const label = links.length === 1 ? 'Dipl√¥me' : Dipl√¥me ${i + 1};
return <button class="diplome-btn" onclick="window.open('${link}', '_blank')">üéì ${label}</button>;
}).join('');
}
}
let gradeHTML = emp.grade;
if (currentUser.role === 'admin' || currentUser.role === 'rh') {
gradeHTML =       <div class="grade-selector">         <button onclick="toggleGradeOptions(event)">${emp.grade || 'S√©lectionner'}</button>         <div class="grade-options">           ${GRADES.map(g =><div class="grade-option" onclick="updateGrade('${emp.id}', '${g}')">${g}</div>).join('')}         </div>       </div>     ;
}
content.innerHTML =     <tr><td>ID Unique</td><td>${emp.id || '-'}</td></tr>     <tr><td>RIB</td><td>${emp.rib || '-'}</td></tr>     <tr><td>Grade</td><td>${gradeHTML}</td></tr>     <tr><td>T√©l√©phone</td><td>${emp.tel || '-'}</td></tr>     <tr><td>Discord</td><td>${emp.discord || '-'}</td></tr>     <tr><td>Gmail</td><td>${emp.gmail || '-'}</td></tr>     <tr><td>üéì Dipl√¥me</td><td>${diplomeHTML}</td></tr>     <tr><td>Date d'entr√©e</td><td>${emp.entree || '-'}</td></tr>     <tr><td>Date de sortie</td><td>${emp.sortie || '-'}</td></tr>     <tr><td>Sanction</td><td>${emp.sanction || '-'}</td></tr>     <tr><td>Date retrait</td><td>${emp.retrait || '-'}</td></tr>  ;
modal.classList.add('active');
addLog(Consultation du profil de "${emp.nom}");
}
function toggleGradeOptions(event) {
event.stopPropagation();
const options = event.target.nextElementSibling;
options.classList.toggle('active');
}
async function updateGrade(empId, newGrade) {
const emp = filteredEmployees.find(e => e.id === empId);
const empName = emp ? emp.nom : 'Inconnu';
await addLog(Modification du grade de "${empName}" ‚Üí "${newGrade}");
showToast(Grade mis √† jour: ${newGrade}, 'success');
closeModal();
loadEmployees();
}
function closeModal() {
document.getElementById('employeeModal').classList.remove('active');
}
// ==================== RECRUITS ====================
async function loadRecruits() {
if (currentUser.role !== 'admin' && currentUser.role !== 'rh') return;
const list = document.getElementById('recruitList');
try {
list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RECRUITMENT)}?key=${API_KEY}`;
const response = await fetch(url);
const data = await response.json();

if (!data.values) {
  list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
  return;
}

const rows = data.values;
let headerIndex = 0;

const dataRows = rows.slice(headerIndex + 1);
const unique = new Set();

allRecruits = dataRows
  .map(r => ({
    id: r[3] ? r[3].toString().trim() : '',
    nom: r[4] ? r[4].toString().trim() : '',
    statut: r[26] ? r[26].toString().trim() : 'En attente'
  }))
  .filter(c => {
    if (!c.nom || unique.has(c.nom)) return false;
    unique.add(c.nom);
    return true;
  })
  .reverse();

filteredRecruits = [...allRecruits];
displayRecruits(filteredRecruits);
} catch (error) {
list.innerHTML = <div class="info-message">‚ùå Erreur: ${error.message}</div>;
}
}
function displayRecruits(recruits) {
const list = document.getElementById('recruitList');
list.innerHTML = '';
if (recruits.length === 0) {
list.innerHTML = '<div class="info-message">Aucun candidat trouv√©</div>';
return;
}
recruits.forEach(rec => {
const card = document.createElement('div');
card.className = 'employee-card';
card.innerHTML = `
  <div class="employee-name">${rec.nom}</div>
  <div class="employee-grade">${rec.statut}</div>
`;

list.appendChild(card);
});
}
// ==================== SEARCH ====================
let searchTimeout;
function logSearch(query, type) {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(() => {
if (query.length >= 3) {
addLog(Recherche ${type}: "${query}");
}
}, 3000);
}
document.addEventListener('DOMContentLoaded', () => {
const searchBar = document.getElementById('searchBar');
if (searchBar) {
searchBar.addEventListener('input', (e) => {
const query = e.target.value.toLowerCase();
logSearch(query, 'employ√©s');
filteredEmployees = allEmployees.filter(emp =>
emp.nom.toLowerCase().includes(query) ||
emp.grade.toLowerCase().includes(query)
);
displayEmployees(filteredEmployees);
});
}
const searchBarRecruit = document.getElementById('searchBarRecruit');
if (searchBarRecruit) {
searchBarRecruit.addEventListener('input', (e) => {
const query = e.target.value.toLowerCase();
logSearch(query, 'candidats');
filteredRecruits = allRecruits.filter(rec =>
rec.nom.toLowerCase().includes(query)
);
displayRecruits(filteredRecruits);
});
}
});
// ==================== LOGS ====================
async function loadLogsPage() {
const logsContainer = document.getElementById('logsContainer');
if (!logsContainer) return;
try {
logsContainer.innerHTML = '<p style="text-align: center;">‚è≥ Chargement des logs...</p>';
const url = `https://sheets.googleapis.com/v4/spreadsheets/${LOGS_SHEET_ID}/values/A:C?key=${LOGS_API_KEY}`;
const response = await fetch(url);
const data = await response.json();

if (!data.values || data.values.length <= 1) {
  logsContainer.innerHTML = `
    <div style="text-align: center; padding: 2rem; background: rgba(233, 69, 96, 0.1); border-radius: 16px; border: 1px solid var(--color-highlight);">
      <p><strong>üìú Historique des actions</strong></p>
      <p style="margin-top: 1rem; color: var(--color-text-dim);">Aucun log pour le moment.</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-dim);">Les actions seront enregistr√©es ici automatiquement.</p>
    </div>
  `;
  return;
}

const logs = data.values.slice(1).reverse();

let html = `
  <div style="background: rgba(26, 26, 46, 0.8); backdrop-filter: blur(20px); border: 1px solid var(--color-border); border-radius: 16px; overflow: hidden;">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; color: var(--color-text);">üìú Historique des actions (${logs.length})</h3>
      <button onclick="loadLogsPage()" style="background: rgba(233, 69, 96, 0.2); border: 1px solid var(--color-highlight); color: var(--color-highlight); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
        üîÑ Actualiser
      </button>
    </div>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(233, 69, 96, 0.1); border-bottom: 2px solid var(--color-highlight);">
            <th style="padding: 1rem; text-align: left; color: var(--color-text); font-weight: 600;">üë§ Utilisateur</th>
            <th style="padding: 1rem; text-align: left; color: var(--color-text); font-weight: 600;">üïê Date et heure</th>
            <th style="padding: 1rem; text-align: left; color: var(--color-text); font-weight: 600;">‚ö° Action</th>
          </tr>
        </thead>
        <tbody>
`;

logs.forEach((log, index) => {
  const [prenom, date, action] = log;
  const bgColor = index % 2 === 0 ? 'rgba(255, 255, 255, 0.02)' : 'transparent';
  
  html += `
    <tr style="border-bottom: 1px solid var(--color-border); background: ${bgColor};">
      <td style="padding: 1rem; color: var(--color-text);">${prenom || '-'}</td>
      <td style="padding: 1rem; color: var(--color-text-dim); font-size: 0.9rem;">${date || '-'}</td>
      <td style="padding: 1rem; color: var(--color-text);">${action || '-'}</td>
    </tr>
  `;
});

html += `
        </tbody>
      </table>
    </div>
  </div>
`;

logsContainer.innerHTML = html;
} catch (error) {
console.error('‚ùå Erreur chargement logs:', error);
logsContainer.innerHTML =       <div style="text-align: center; padding: 2rem; background: rgba(233, 69, 96, 0.2); border-radius: 16px; border: 1px solid var(--color-highlight);">         <p><strong>‚ùå Erreur de chargement</strong></p>         <p style="margin-top: 1rem; color: var(--color-text-dim);">${error.message}</p>         <button onclick="loadLogsPage()" style="margin-top: 1rem; background: var(--color-highlight); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">           R√©essayer         </button>       </div>    ;
}
}
async function addLog(action) {
if (!currentUser) {
console.error('‚ùå Pas d'utilisateur connect√©');
return;
}
try {
const userName = currentUser.employeeName || currentUser.username;
const now = new Date();
const dateTime = now.toLocaleString('fr-FR', {
day: '2-digit',
month: '2-digit',
year: 'numeric',
hour: '2-digit',
minute: '2-digit',
second: '2-digit'
});
const logData = {
  userName: userName,
  dateTime: dateTime,
  action: action
};

console.log('üìù Enregistrement log:', logData);

await fetch(APPS_SCRIPT_URL, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(logData),
  mode: 'no-cors'
});

console.log('‚úÖ Log envoy√© avec succ√®s');

if (document.getElementById('tab-logs')?.classList.contains('active')) {
  setTimeout(() => loadLogsPage(), 1500);
}
} catch (error) {
console.error('‚ùå Erreur addLog:', error);
}
}
// ==================== TOAST ====================
function showToast(message, type = 'success') {
const toast = document.getElementById('toast');
toast.textContent = message;
toast.className = toast ${type} show;
setTimeout(() => {
toast.classList.remove('show');
}, 3000);
}
// ==================== PERMISSIONS ====================
const PERMISSIONS = {
"Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
"Co Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
"DRH": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "banque", "logs"],
"Responsable D'atelier": ["profil", "accueil", "employes", "absence", "factures", "partenariats", "banque", "logs"],
"Responsable Evenementiel": ["profil", "accueil", "factures", "banque"],
"Asst Evenemtiel": ["profil", "accueil", "factures", "banque"],
"Chef d'atelier": ["profil", "accueil", "employes", "absence", "factures", "logs"],
"RH": ["profil", "accueil", "employes", "recrutement", "absence"],
"Confirm√©": ["profil", "accueil"],
"M√©cano": ["profil", "accueil"],
"Apprenti": ["profil", "accueil"],
"Stagiaire": ["profil", "accueil"]
};
const CATEGORY_ICONS = {
"profil": "üë§",
"accueil": "üè†",
"employes": "üë•",
"recrutement": "üìã",
"absence": "üìÖ",
"factures": "üí∞",
"partenariats": "ü§ù",
"banque": "üè¶",
"compta": "üìä",
"logs": "üìú"
};
const CATEGORY_LABELS = {
"profil": "Profil",
"accueil": "Accueil",
"employes": "Employ√©s",
"recrutement": "Recrutement",
"absence": "Absences",
"factures": "Factures",
"partenariats": "Partenariats",
"banque": "Banque",
"compta": "Compta",
"logs": "Logs"
};
let userCategories = [];
function getUserCategories(grade) {
return PERMISSIONS[grade] || ["profil", "accueil"];
}
function buildNavigation() {
if (!currentUser || !currentUser.grade) {
console.log('‚ùå Pas de grade utilisateur');
userCategories = ["profil", "accueil"];
} else {
userCategories = getUserCategories(currentUser.grade);
}
console.log('‚úÖ Grade:', currentUser?.grade);
console.log('‚úÖ Cat√©gories:', userCategories);
const nav = document.getElementById('mainNavigation');
if (!nav) return;
nav.innerHTML = userCategories.map((cat, index) => {
const icon = CATEGORY_ICONS[cat] || "üìÑ";
const label = CATEGORY_LABELS[cat] || cat;
const activeClass = index === 0 ? 'active' : '';
return <div class="nav-item ${activeClass}" onclick="switchTab('${cat}')">${icon} ${label}</div>;
}).join('');
if (userCategories.length > 0) {
const firstTab = document.getElementById('tab-' + userCategories[0]);
if (firstTab) firstTab.classList.add('active');
}
}
function loadProfilPage() {
if (!currentUser) return;
const profilContent = document.getElementById('profilContent');
if (!profilContent) return;
profilContent.innerHTML = `
<h2>üë§ Mon Profil</h2>
<div style="margin-top: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
<div style="text-align: center; margin-bottom: 2rem;">
<img src="${currentUser.avatar}" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-highlight);">
</div>
  <table class="details-table">
    <tr><td><strong>Nom</strong></td><td>${currentUser.employeeName || currentUser.username}</td></tr>
    <tr><td><strong>Grade</strong></td><td>${currentUser.grade || 'Non d√©fini'}</td></tr>
    <tr><td><strong>Discord</strong></td><td>${currentUser.username}#${currentUser.discriminator}</td></tr>
    <tr><td><strong>ID Discord</strong></td><td>${currentUser.id}</td></tr>
    <tr><td><strong>R√¥le syst√®me</strong></td><td>${currentUser.role}</td></tr>
    <tr><td><strong>Cat√©gories accessibles</strong></td><td>${userCategories.length}</td></tr>
  </table>
  
  <div style="margin-top: 2rem; text-align: center;">
    <button class="logout-btn" onclick="logout()" style="display: inline-block;">
      üö™ D√©connexion
    </button>
  </div>
</div>
`;
}
// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
console.log('üöÄ App d√©marrage...');
const params = new URLSearchParams(window.location.search);
const authStatus = params.get('auth');
const error = params.get('error');
if (authStatus === 'success') {
checkAuth();
window.history.replaceState({}, document.title, window.location.pathname);
} else if (error) {
const errors = {
'no_code': 'Code d'autorisation manquant',
'not_employee': 'Votre ID Discord n'est pas dans la liste des employ√©s',
'auth_failed': '√âchec de l'authentification',
'session_error': 'Erreur de cr√©ation de session'
};
showToast(‚ùå ${errors[error] || 'Erreur inconnue'}, 'error');
showLogin();
} else {
checkAuth();
}
});
document.getElementById('employeeModal').addEventListener('click', (e)Continuer19:39=> {
if (e.target.id === 'employeeModal') {
closeModal();
}
});
</script>
</body>
</html></parameter>
