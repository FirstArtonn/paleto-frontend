<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paleto Garage - Gestion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --color-primary: #1a1a2e;
  --color-secondary: #16213e;
  --color-accent: #0f3460;
  --color-highlight: #e94560;
  --color-gold: #d4af37;
  --color-bg: #0a0a12;
  --color-surface: #1a1a2e;
  --color-text: #e8e8e8;
  --color-text-dim: #a0a0a8;
  --color-border: #2a2a3e;
}

[data-theme="light"] {
  --color-primary: #f8fafc;
  --color-secondary: #e2e8f0;
  --color-accent: #cbd5e1;
  --color-highlight: #6366f1;
  --color-gold: #8b5cf6;
  --color-bg: #ffffff;
  --color-surface: #f8fafc;
  --color-text: #0f172a;
  --color-text-dim: #64748b;
  --color-border: #e2e8f0;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Outfit', sans-serif;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
  color: var(--color-text);
  min-height: 100vh;
  transition: background 0.3s ease, color 0.3s ease;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(15, 52, 96, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}


/* Navigation - SEULEMENT soulignement */
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: #fff;
  cursor: pointer;
  padding: 8px 0;
  transition: none;
  user-select: none;
  background: none;
  border: none;
}

.nav-item:hover {
  color: #fff;
  background: none;
  transform: none;
}

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: #fff;
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after {
  width: 100%;
}

.nav-item:hover::after {
  width: 100%;
}
.content-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}


/* Navigation - SEULEMENT soulignement */
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: #fff;
  cursor: pointer;
  padding: 8px 0;
  transition: none;
  user-select: none;
  background: none;
  border: none;
}

.nav-item:hover {
  color: #fff;
  background: none;
  transform: none;
}

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: #fff;
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after {
  width: 100%;
}

.nav-item:hover::after {
  width: 100%;
}
.navigation {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: none !important;
  border: none !important;
  padding: 0 !important;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--color-text);
  cursor: pointer;
  padding: 8px 0;
  background: none !important;
  border: none !important;
  transition: color 0.3s ease;
  user-select: none;
}

.nav-item:hover {
  color: var(--color-highlight);
}

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: var(--color-highlight);
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after {
  width: 100%;
}

</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-container" id="loginContainer">
  <div class="login-card">
    <h1>PALETO GARAGE</h1>
    <p>Connectez-vous avec Discord pour acc√©der au syst√®me de gestion</p>
    
    <button class="discord-login-btn" onclick="loginWithDiscord()">
      <svg viewBox="0 0 127.14 96.36" fill="currentColor">
        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
      </svg>
      Se connecter avec Discord
    </button>

    <div class="login-info">
      <strong>‚ÑπÔ∏è Information</strong><br>
      Votre ID Discord doit √™tre dans la liste des employ√©s pour acc√©der √† cette application.
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
  <header>
    <div class="user-profile" id="userProfile">
      <img id="userAvatar" src="" alt="Avatar">
      <span class="username" id="userName"></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>

    <div class="theme-toggle" onclick="toggleTheme()" title="Changer de th√®me">
      <div class="theme-slider">
        <span class="theme-icon">üåô</span>
      </div>
    </div>

    <h1>PALETO GARAGE</h1>
    <div class="subtitle">Syst√®me de Gestion - By Artonn</div>

    <nav class="navigation" id="mainNavigation">
      <!-- Navigation g√©n√©r√©e dynamiquement -->
    </nav>
  </header>

  <div class="content-container">
    <!-- ACCUEIL -->
    <div class="tab-content active" id="tab-accueil">
      <div class="info-message">
        <h2>üëã Bienvenue <span id="welcomeName"></span></h2>
        <p style="margin-top: 1rem;">Utilisez le menu ci-dessus pour naviguer entre les diff√©rentes sections.</p>
        <div style="margin-top: 2rem; padding: 2rem; background: rgba(233, 69, 96, 0.1); border-radius: 16px; border: 1px solid var(--color-highlight);">
          <strong>Vos permissions :</strong>
          <p id="userPermissions" style="margin-top: 1rem;"></p>
        </div>
      </div>
    </div>

    <!-- EMPLOY√âS -->
    <div class="tab-content" id="tab-employes">
      <div class="search-container">
        <input type="text" class="search-input" id="searchBar" placeholder="üîç Rechercher un employ√©...">
      </div>
      <div class="employee-grid" id="employeeList"></div>
    </div>

    <!-- RECRUTEMENT -->
    <div class="tab-content" id="tab-recrutement">
      <div class="search-container">
        <input type="text" class="search-input" id="searchBarRecruit" placeholder="üîç Rechercher un candidat...">
      </div>
      <div class="employee-grid" id="recruitList"></div>
    </div>

    <!-- FACTURES -->
    <div class="tab-content" id="tab-factures">
      <div class="iframe-container">
        <iframe src="Facture_Paleto.html"></iframe>
      </div>
    </div>

    <!-- ABSENCE -->
    <div class="tab-content" id="tab-absence">
      <div class="info-message">
        <h2>üìÖ Gestion des absences</h2>
        <p style="margin-top: 1rem;">Cette section est en cours de d√©veloppement.</p>
      </div>
    </div>
    <!-- PROFIL -->
    <div class="tab-content" id="tab-profil">
      <div class="info-message" id="profilContent">
        <h2>üë§ Mon Profil</h2>
        <p style="margin-top: 1rem;">Chargement...</p>
      </div>
    </div>

    <!-- PARTENARIATS -->
    <div class="tab-content" id="tab-partenariats">
      <div class="info-message">
        <h2>ü§ù Partenariats</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- BANQUE -->
    <div class="tab-content" id="tab-banque">
      <div class="info-message">
        <h2>üè¶ Banque</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- COMPTA -->
    <div class="tab-content" id="tab-compta">
      <div class="info-message">
        <h2>üìä Comptabilit√©</h2>
        <p style="margin-top: 1rem;">Section en cours de d√©veloppement.</p>
      </div>
    </div>

    <!-- LOGS -->
    <div class="tab-content" id="tab-logs">
      <div class="info-message">
        <h2>üìú Historique</h2>
        <div id="logsContainer" style="margin-top: 2rem;">
          <p>Chargement des logs...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EMPLOYEE DETAILS MODAL -->
<div class="modal" id="employeeModal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">‚úñ</div>
    <h2 id="modalTitle"></h2>
    <table class="details-table" id="modalContent"></table>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ==================== CONFIG ====================
const BACKEND_URL = "https://paleto-backend.vercel.app";
const SHEET_ID = "17ZntDHZ8olidnCM1pig311AcjawM4l6HoRxSYFP7KGw";
const API_KEY = "AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E";
const SHEET_EMPLOYEES = "Info Employ√©";
const SHEET_RECRUITMENT = "Formulaire Info ";

const GRADES = [
  "Patron", "Co Patron", "DRH", "RH", "Responsable D'atelier",
  "Chef d'atelier", "Confirm√©", "M√©cano", "Apprenti", "Stagiaire"
];

let currentUser = null;
let allEmployees = [];
let filteredEmployees = [];
let allRecruits = [];
let filteredRecruits = [];

// ==================== AUTH ====================
function loginWithDiscord() {
  console.log('üîó Connexion Discord...');
  window.location.href = `${BACKEND_URL}/auth/discord`;
}

async function checkAuth() {
  try {
    console.log('üîç V√©rification auth...');
    const response = await fetch(`${BACKEND_URL}/api/check-auth`, {
      credentials: 'include'
    });
    
    const data = await response.json();
    console.log('üì• R√©ponse:', data);
    
    if (data.authenticated) {
      currentUser = data.user;
      showApp();
    } else {
      showLogin();
    }
  } catch (error) {
    console.error('‚ùå Erreur auth:', error);
    showLogin();
  }
}

async function logout() {
  try {
    await fetch(`${BACKEND_URL}/api/logout`, {
      method: 'POST',
      credentials: 'include'
    });
    currentUser = null;
    showLogin();
    showToast('üëã D√©connexion r√©ussie', 'success');
  } catch (error) {
    console.error('‚ùå Erreur logout:', error);
  }
}

function showLogin() {
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

function showApp() {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  document.getElementById('userAvatar').src = currentUser.avatar;
  document.getElementById('userName').textContent = currentUser.employeeName || currentUser.username;
  document.getElementById('welcomeName').textContent = currentUser.employeeName || currentUser.username;
  
  const permissions = {
    'admin': 'Administrateur - Acc√®s complet',
    'rh': 'Ressources Humaines - Acc√®s aux employ√©s et recrutement',
    'employee': 'Employ√© - Consultation uniquement',
    'visitor': 'Visiteur - Acc√®s limit√©'
  };
  document.getElementById('userPermissions').textContent = permissions[currentUser.role];
  
  document.body.className = `role-${currentUser.role}`;
  
  buildNavigation();
  loadProfilPage();
  loadLogsPage();
  loadEmployees();
  loadRecruits();
}

// ==================== NAVIGATION ====================
function switchTab(tabName) {
  // D√©sactiver tous les nav-items
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Activer le bon nav-item
  document.querySelectorAll('.nav-item').forEach(item => {
    const onclick = item.getAttribute('onclick');
    if (onclick && onclick.includes("'" + tabName + "'")) {
      item.classList.add('active');
    }
  });
  
  // Masquer tous les tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Afficher le bon tab
  const targetTab = document.getElementById('tab-' + tabName);
  if (targetTab) {
    targetTab.classList.add('active');
  }
}

// ==================== THEME ====================

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.querySelector('.theme-icon').textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

// ==================== EMPLOYEES ====================
async function loadEmployees() {
  const list = document.getElementById('employeeList');
  
  try {
    list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
    
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_EMPLOYEES)}?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.values) {
      list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
      return;
    }

    const rows = data.values;
    let headerIndex = -1;
    
    for (let i = 0; i < rows.length; i++) {
      if (rows[i] && rows[i].some(cell => 
        cell && cell.toString().includes("Pr√©nom / Nom")
      )) {
        headerIndex = i;
        break;
      }
    }
    
    if (headerIndex === -1) {
      list.innerHTML = '<div class="info-message">‚ùå En-t√™te introuvable</div>';
      return;
    }

    const dataRows = rows.slice(headerIndex + 1);
    const unique = new Set();

    allEmployees = dataRows
      .filter(row => {
        const nom = row[2] ? row[2].toString().trim() : '';
        return nom && nom !== "Pr√©nom / Nom" && nom !== "D√©mission/Licenciement";
      })
      .map(r => ({
        id: r[1] ? r[1].toString().trim() : '',
        nom: r[2] ? r[2].toString().trim() : '',
        rib: r[3] ? r[3].toString().trim() : '',
        grade: r[4] ? r[4].toString().trim() : '',
        tel: r[5] ? r[5].toString().trim() : '',
        discord: r[6] ? r[6].toString().trim() : '',
        gmail: r[8] ? r[8].toString().trim() : '',
        diplome: r[9] ? r[9].toString().trim() : '',
        entree: r[10] ? r[10].toString().trim() : '',
        sortie: r[11] ? r[11].toString().trim() : '',
        sanction: r[12] ? r[12].toString().trim() : '',
        retrait: r[13] ? r[13].toString().trim() : ''
      }))
      .filter(e => {
        if (!e.nom || unique.has(e.nom)) return false;
        unique.add(e.nom);
        return true;
      });

    filteredEmployees = [...allEmployees];
    displayEmployees(filteredEmployees);

  } catch (error) {
    list.innerHTML = `<div class="info-message">‚ùå Erreur: ${error.message}</div>`;
  }
}

function displayEmployees(employees) {
  const list = document.getElementById('employeeList');
  list.innerHTML = '';

  if (employees.length === 0) {
    list.innerHTML = '<div class="info-message">Aucun employ√© trouv√©</div>';
    return;
  }

  employees.forEach((emp, index) => {
    const card = document.createElement('div');
    card.className = 'employee-card';
    
    if (emp.sanction === 'Avertissement 1') card.classList.add('sanction-1');
    if (emp.sanction === 'Avertissement 2') card.classList.add('sanction-2');
    if (emp.sanction === 'Licenciement') card.classList.add('sanction-3');
    
    card.innerHTML = `
      <div class="employee-name">${emp.nom}</div>
      <div class="employee-grade">${emp.grade || 'Sans grade'}</div>
    `;
    
    card.onclick = () => showEmployeeDetails(index);
    list.appendChild(card);
  });
}

function showEmployeeDetails(index) {
  const emp = filteredEmployees[index];
  const modal = document.getElementById('employeeModal');
  const title = document.getElementById('modalTitle');
  const content = document.getElementById('modalContent');
  
  title.textContent = `üë§ ${emp.nom}`;
  
  let diplomeHTML = '<em>Aucun dipl√¥me</em>';
  if (emp.diplome) {
    const links = emp.diplome.split(/\s+/).filter(l => l.startsWith('http'));
    if (links.length > 0) {
      diplomeHTML = links.map((link, i) => {
        const label = links.length === 1 ? 'Dipl√¥me' : `Dipl√¥me ${i + 1}`;
        return `<button class="diplome-btn" onclick="window.open('${link}', '_blank')">üéì ${label}</button>`;
      }).join('');
    }
  }
  
  let gradeHTML = emp.grade;
  if (currentUser.role === 'admin' || currentUser.role === 'rh') {
    gradeHTML = `
      <div class="grade-selector">
        <button onclick="toggleGradeOptions(event)">${emp.grade || 'S√©lectionner'}</button>
        <div class="grade-options">
          ${GRADES.map(g => `<div class="grade-option" onclick="updateGrade('${emp.id}', '${g}')">${g}</div>`).join('')}
        </div>
      </div>
    `;
  }
  
  content.innerHTML = `
    <tr><td>ID Unique</td><td>${emp.id || '-'}</td></tr>
    <tr><td>RIB</td><td>${emp.rib || '-'}</td></tr>
    <tr><td>Grade</td><td>${gradeHTML}</td></tr>
    <tr><td>T√©l√©phone</td><td>${emp.tel || '-'}</td></tr>
    <tr><td>Discord</td><td>${emp.discord || '-'}</td></tr>
    <tr><td>Gmail</td><td>${emp.gmail || '-'}</td></tr>
    <tr><td>üéì Dipl√¥me</td><td>${diplomeHTML}</td></tr>
    <tr><td>Date d'entr√©e</td><td>${emp.entree || '-'}</td></tr>
    <tr><td>Date de sortie</td><td>${emp.sortie || '-'}</td></tr>
    <tr><td>Sanction</td><td>${emp.sanction || '-'}</td></tr>
    <tr><td>Date retrait</td><td>${emp.retrait || '-'}</td></tr>
  `;
  
  modal.classList.add('active');
}

function toggleGradeOptions(event) {
  event.stopPropagation();
  const options = event.target.nextElementSibling;
  options.classList.toggle('active');
}

async function updateGrade(empId, newGrade) {
  // Ici tu peux ajouter l'appel √† ton API pour mettre √† jour le grade
  showToast(`Grade mis √† jour: ${newGrade}`, 'success');
  closeModal();
  loadEmployees();
}

function closeModal() {
  document.getElementById('employeeModal').classList.remove('active');
}

// ==================== RECRUITS ====================
async function loadRecruits() {
  if (currentUser.role !== 'admin' && currentUser.role !== 'rh') return;
  
  const list = document.getElementById('recruitList');
  
  try {
    list.innerHTML = '<div class="info-message">‚è≥ Chargement...</div>';
    
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RECRUITMENT)}?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.values) {
      list.innerHTML = '<div class="info-message">‚ùå Aucune donn√©e</div>';
      return;
    }

    const rows = data.values;
    let headerIndex = 0;
    
    const dataRows = rows.slice(headerIndex + 1);
    const unique = new Set();

    allRecruits = dataRows
      .map(r => ({
        id: r[3] ? r[3].toString().trim() : '',
        nom: r[4] ? r[4].toString().trim() : '',
        statut: r[26] ? r[26].toString().trim() : 'En attente'
      }))
      .filter(c => {
        if (!c.nom || unique.has(c.nom)) return false;
        unique.add(c.nom);
        return true;
      })
      .reverse();

    filteredRecruits = [...allRecruits];
    displayRecruits(filteredRecruits);

  } catch (error) {
    list.innerHTML = `<div class="info-message">‚ùå Erreur: ${error.message}</div>`;
  }
}

function displayRecruits(recruits) {
  const list = document.getElementById('recruitList');
  list.innerHTML = '';

  if (recruits.length === 0) {
    list.innerHTML = '<div class="info-message">Aucun candidat trouv√©</div>';
    return;
  }

  recruits.forEach(rec => {
    const card = document.createElement('div');
    card.className = 'employee-card';
    
    card.innerHTML = `
      <div class="employee-name">${rec.nom}</div>
      <div class="employee-grade">${rec.statut}</div>
    `;
    
    list.appendChild(card);
  });
}

// ==================== SEARCH ====================
document.addEventListener('DOMContentLoaded', () => {
  const searchBar = document.getElementById('searchBar');
  if (searchBar) {
    searchBar.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      filteredEmployees = allEmployees.filter(emp =>
        emp.nom.toLowerCase().includes(query) ||
        emp.grade.toLowerCase().includes(query)
      );
      displayEmployees(filteredEmployees);
    });
  }
  
  const searchBarRecruit = document.getElementById('searchBarRecruit');
  if (searchBarRecruit) {
    searchBarRecruit.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      filteredRecruits = allRecruits.filter(rec =>
        rec.nom.toLowerCase().includes(query)
      );
      displayRecruits(filteredRecruits);
    });
  }
});

// ==================== TOAST ====================
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ App d√©marrage...');
  
  const params = new URLSearchParams(window.location.search);
  const authStatus = params.get('auth');
  const error = params.get('error');
  
  if (authStatus === 'success') {
    checkAuth();
    window.history.replaceState({}, document.title, window.location.pathname);
  } else if (error) {
    const errors = {
      'no_code': 'Code d\'autorisation manquant',
      'not_employee': 'Votre ID Discord n\'est pas dans la liste des employ√©s',
      'auth_failed': '√âchec de l\'authentification',
      'session_error': 'Erreur de cr√©ation de session'
    };
    showToast(`‚ùå ${errors[error] || 'Erreur inconnue'}`, 'error');
    showLogin();
  } else {
    checkAuth();
  }
});

// Close modal on outside click
document.getElementById('employeeModal').addEventListener('click', (e) => {
  if (e.target.id === 'employeeModal') {
    closeModal();
  }
});


// ==================== COMMUNICATION IFRAME ====================
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? '' : 'light';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const icon = document.querySelector('.theme-icon');
  icon.textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  
  // Envoyer √† l'iframe
  sendThemeToIframe(newTheme);
}

function sendThemeToIframe(theme) {
  const iframe = document.querySelector('#tab-factures iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage({ 
      type: 'theme-change', 
      theme: theme 
    }, '*');
  }
}

// √âcouter les demandes de l'iframe
window.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'get-theme') {
    const currentTheme = document.documentElement.getAttribute('data-theme') || '';
    sendThemeToIframe(currentTheme);
  }
});

// Envoyer le theme quand l'iframe charge
document.addEventListener('DOMContentLoaded', () => {
  const iframe = document.querySelector('#tab-factures iframe');
  if (iframe) {
    iframe.addEventListener('load', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme') || '';
      sendThemeToIframe(currentTheme);
    });
  }
});


// ==================== SYST√àME DE PERMISSIONS ====================
const PERMISSIONS = {
  "Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
  "Co Patron": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "partenariats", "banque", "compta", "logs"],
  "DRH": ["profil", "accueil", "employes", "recrutement", "absence", "factures", "banque", "logs"],
  "Responsable D'atelier": ["profil", "accueil", "employes", "absence", "factures", "partenariats", "banque", "logs"],
  "Responsable Evenementiel": ["profil", "accueil", "factures", "banque"],
  "Asst Evenemtiel": ["profil", "accueil", "factures", "banque"],
  "Chef d'atelier": ["profil", "accueil", "employes", "absence", "factures", "logs"],
  "RH": ["profil", "accueil", "employes", "recrutement", "absence"],
  "Confirm√©": ["profil", "accueil"],
  "M√©cano": ["profil", "accueil"],
  "Apprenti": ["profil", "accueil"],
  "Stagiaire": ["profil", "accueil"]
};

const CATEGORY_ICONS = {
  "profil": "üë§",
  "accueil": "üè†",
  "employes": "üë•",
  "recrutement": "üìã",
  "absence": "üìÖ",
  "factures": "üí∞",
  "partenariats": "ü§ù",
  "banque": "üè¶",
  "compta": "üìä",
  "logs": "üìú"
};

const CATEGORY_LABELS = {
  "profil": "Profil",
  "accueil": "Accueil",
  "employes": "Employ√©s",
  "recrutement": "Recrutement",
  "absence": "Absences",
  "factures": "Factures",
  "partenariats": "Partenariats",
  "banque": "Banque",
  "compta": "Compta",
  "logs": "Logs"
};

let userCategories = [];

function getUserCategories(grade) {
  return PERMISSIONS[grade] || ["profil", "accueil"];
}

function buildNavigation() {
  if (!currentUser || !currentUser.grade) {
    console.log('‚ùå Pas de grade utilisateur');
    userCategories = ["profil", "accueil"];
  } else {
    userCategories = getUserCategories(currentUser.grade);
  }
  
  console.log('‚úÖ Grade:', currentUser?.grade);
  console.log('‚úÖ Cat√©gories:', userCategories);
  
  const nav = document.getElementById('mainNavigation');
  if (!nav) return;
  
  nav.innerHTML = userCategories.map((cat, index) => {
    const icon = CATEGORY_ICONS[cat] || "üìÑ";
    const label = CATEGORY_LABELS[cat] || cat;
    const activeClass = index === 0 ? 'active' : '';
    return `<div class="nav-item ${activeClass}" onclick="switchTab('${cat}')">${icon} ${label}</div>`;
  }).join('');
  
  if (userCategories.length > 0) {
    switchTab(userCategories[0]);
  }
}

function loadProfilPage() {
  if (!currentUser) return;
  
  const profilContent = document.getElementById('profilContent');
  if (!profilContent) return;
  
  profilContent.innerHTML = `
    <h2>üë§ Mon Profil</h2>
    <div style="margin-top: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
      <div style="text-align: center; margin-bottom: 2rem;">
        <img src="${currentUser.avatar}" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-highlight);">
      </div>
      
      <table class="details-table">
        <tr><td><strong>Nom</strong></td><td>${currentUser.employeeName || currentUser.username}</td></tr>
        <tr><td><strong>Grade</strong></td><td>${currentUser.grade || 'Non d√©fini'}</td></tr>
        <tr><td><strong>Discord</strong></td><td>${currentUser.username}#${currentUser.discriminator}</td></tr>
        <tr><td><strong>ID Discord</strong></td><td>${currentUser.id}</td></tr>
        <tr><td><strong>R√¥le syst√®me</strong></td><td>${currentUser.role}</td></tr>
        <tr><td><strong>Cat√©gories accessibles</strong></td><td>${userCategories.length}</td></tr>
      </table>
      
      <div style="margin-top: 2rem; text-align: center;">
        <button class="logout-btn" onclick="logout()" style="display: inline-block;">
          üö™ D√©connexion
        </button>
      </div>
    </div>
  `;
}

function loadLogsPage() {
  const logsContainer = document.getElementById('logsContainer');
  if (!logsContainer) return;
  
  logsContainer.innerHTML = `
    <div style="text-align: center; padding: 2rem; background: rgba(233, 69, 96, 0.1); border-radius: 16px; border: 1px solid var(--color-highlight);">
      <p><strong>üìú Historique des actions</strong></p>
      <p style="margin-top: 1rem; color: var(--color-text-dim);">Aucun log pour le moment.</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-dim);">Les actions importantes seront enregistr√©es ici.</p>
    </div>
  `;
}

</script>
</body>
</html>
